<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬å…¨å›½ä¸–å¸¯å¹´åãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</title>

```
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
    }
    
    #map {
        height: 100vh;
        width: 100%;
    }
    
    .info {
        padding: 12px 16px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255,255,255,0.95);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 10px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .info h4 {
        margin: 0 0 10px;
        color: #333;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
    }
    
    .legend {
        line-height: 22px;
        color: #555;
        font-size: 13px;
    }
    
    .legend i {
        width: 20px;
        height: 18px;
        float: left;
        margin-right: 10px;
        opacity: 0.9;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    .info-details {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #ddd;
    }
    
    .info-details p {
        margin: 6px 0;
        font-size: 12px;
        line-height: 1.4;
    }
    
    .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px 50px;
        border-radius: 15px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        z-index: 1000;
        font-size: 18px;
        color: #333;
        text-align: center;
        border: 2px solid #e0e0e0;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .stats-panel {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255,255,255,0.95);
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        font-size: 13px;
        border: 1px solid rgba(255,255,255,0.3);
        backdrop-filter: blur(10px);
        min-width: 200px;
    }
    
    .stats-panel h5 {
        margin: 0 0 8px 0;
        font-size: 16px;
        color: #333;
        text-align: center;
    }
    
    .stats-item {
        margin: 5px 0;
        display: flex;
        justify-content: space-between;
    }
    
    .controls-panel {
        position: absolute;
        top: 15px;
        left: 15px;
        background: rgba(255,255,255,0.95);
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        backdrop-filter: blur(10px);
        max-width: 250px;
    }
    
    .controls-panel h5 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #333;
    }
    
    .control-item {
        margin: 8px 0;
    }
    
    .control-item label {
        font-size: 12px;
        color: #555;
        display: block;
        margin-bottom: 3px;
    }
    
    .control-item input, .control-item select {
        width: 100%;
        padding: 4px 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 11px;
    }
    
    .prefecture-filter {
        max-height: 120px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
        background: white;
    }
    
    .prefecture-filter label {
        display: block;
        font-size: 11px;
        margin: 2px 0;
        cursor: pointer;
    }
    
    .prefecture-filter input[type="checkbox"] {
        width: auto;
        margin-right: 5px;
    }
    
    .error-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #ffebee;
        color: #c62828;
        padding: 20px 30px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 1001;
        font-size: 16px;
        text-align: center;
        border: 2px solid #ffcdd2;
        max-width: 400px;
    }
    
    .collapse-btn {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        font-size: 12px;
        float: right;
    }
</style>
```

</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        <div style="font-size: 14px; margin-top: 10px; color: #666;">
            å…¨å›½ã®ä¸–å¸¯å¹´åãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¦ã„ã¾ã™
        </div>
    </div>

```
<div id="map"></div>

<div class="stats-panel">
    <h5>ğŸ“Š ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ</h5>
    <div class="stats-item">
        <span>ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ:</span>
        <span id="dataPoints">è¨ˆç®—ä¸­...</span>
    </div>
    <div class="stats-item">
        <span>éƒ½é“åºœçœŒæ•°:</span>
        <span id="prefectureCount">-</span>
    </div>
    <div class="stats-item">
        <span>å¹³å‡å¹´å:</span>
        <span id="averageIncome">-</span>
    </div>
    <div class="stats-item">
        <span>æœ€é«˜å¹´å:</span>
        <span id="maxIncome">-</span>
    </div>
    <div class="stats-item">
        <span>æœ€ä½å¹´å:</span>
        <span id="minIncome">-</span>
    </div>
</div>

<div class="controls-panel" id="controlsPanel">
    <h5>ğŸ›ï¸ è¡¨ç¤ºè¨­å®š <button class="collapse-btn" onclick="toggleControls()">â”€</button></h5>
    <div id="controlsContent">
        <div class="control-item">
            <label>å¹´åç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
            <select id="incomeFilter">
                <option value="all">ã™ã¹ã¦è¡¨ç¤º</option>
                <option value="high">é«˜æ‰€å¾—(700ä¸‡å††ä»¥ä¸Š)</option>
                <option value="middle-high">ä¸­é«˜æ‰€å¾—(550-700ä¸‡å††)</option>
                <option value="middle">ä¸­æ‰€å¾—(400-550ä¸‡å††)</option>
                <option value="low">ä½æ‰€å¾—(400ä¸‡å††æœªæº€)</option>
            </select>
        </div>
        <div class="control-item">
            <label>ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—å¼·åº¦:</label>
            <input type="range" id="heatIntensity" min="0.3" max="2.0" step="0.1" value="1.0">
        </div>
        <div class="control-item">
            <label>è¡¨ç¤ºã™ã‚‹éƒ½é“åºœçœŒ:</label>
            <div class="prefecture-filter" id="prefectureFilter">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<!-- Leaflet Heat -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<!-- SheetJS for Excel reading -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let map;
    let heatLayer;
    let markerLayer;
    let allData = [];
    let filteredData = [];
    let prefectures = new Set();

    // åœ°å›³ã®åˆæœŸåŒ–
    function initializeMap() {
        map = L.map('map').setView([36.2048, 138.2529], 6); // æ—¥æœ¬ä¸­å¿ƒ

        // OpenStreetMapã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿½åŠ 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã®åˆæœŸåŒ–
        markerLayer = L.layerGroup().addTo(map);
    }

    // ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã®å®šç¾©
    function getColor(income) {
        return income > 800 ? '#800026' :
               income > 700 ? '#BD0026' :
               income > 600 ? '#E31A1C' :
               income > 550 ? '#FC4E2A' :
               income > 500 ? '#FD8D3C' :
               income > 450 ? '#FEB24C' :
               income > 400 ? '#FED976' :
               income > 350 ? '#FFEDA0' :
                              '#FFFFCC';
    }

    // XLSXãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
    async function loadData() {
        try {
            console.log('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');
            const response = await fetch('./japan_household_income_data.xlsx');
            if (!response.ok) {
                throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status} ${response.statusText}`);
            }
            
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            
            console.log('Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æä¸­...');
            console.log('åˆ©ç”¨å¯èƒ½ãªã‚·ãƒ¼ãƒˆ:', workbook.SheetNames);
            
            // æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’å–å¾—
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // JSONã«å¤‰æ›
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            console.log(`ç”Ÿãƒ‡ãƒ¼ã‚¿ä»¶æ•°: ${jsonData.length}`);
            console.log('ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«:', jsonData.slice(0, 3));
            
            // ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã¨ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
            allData = jsonData.map(row => {
                // æ§˜ã€…ãªåˆ—åãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œ
                const prefecture = row.prefecture_name || row['éƒ½é“åºœçœŒå'] || row['éƒ½é“åºœçœŒ'] || '';
                const city = row.city_name || row['å¸‚åŒºç”ºæ‘å'] || row['å¸‚åŒºç”ºæ‘'] || '';
                const district = row.district_name || row['åŒºãƒ»åœ°åŒºå'] || row['åŒºå'] || row['åœ°åŒºå'] || '';
                const subArea = row.sub_area_name || row['è©³ç´°åœ°åŸŸå'] || row['ç”ºä¸ç›®'] || row['ã‚¨ãƒªã‚¢å'] || '';
                
                const lat = parseFloat(row.latitude || row['ç·¯åº¦'] || 0);
                const lng = parseFloat(row.longitude || row['çµŒåº¦'] || 0);
                const income = parseFloat(row.average_income || row['å¹³å‡ä¸–å¸¯å¹´å'] || row['ä¸–å¸¯å¹´å'] || 0);
                const population = parseInt(row.population || row['äººå£'] || 0);
                const households = parseInt(row.household_count || row['ä¸–å¸¯æ•°'] || 0);
                const areaType = row.area_type || row['åœ°åŸŸã‚¿ã‚¤ãƒ—'] || row['ã‚¨ãƒªã‚¢ã‚¿ã‚¤ãƒ—'] || '';
                
                return {
                    prefecture_name: prefecture,
                    city_name: city,
                    district_name: district,
                    sub_area_name: subArea,
                    latitude: lat,
                    longitude: lng,
                    average_income: income,
                    population: population,
                    household_count: households,
                    area_type: areaType
                };
            }).filter(item => {
                // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
                const hasValidCoords = item.latitude && item.longitude && 
                                      item.latitude >= 20 && item.latitude <= 46 &&
                                      item.longitude >= 123 && item.longitude <= 146;
                const hasValidIncome = item.average_income && item.average_income > 0;
                const hasLocation = item.prefecture_name || item.city_name;
                
                return hasValidCoords && hasValidIncome && hasLocation;
            });

            // éƒ½é“åºœçœŒãƒªã‚¹ãƒˆã®ä½œæˆ
            allData.forEach(item => {
                if (item.prefecture_name) {
                    prefectures.add(item.prefecture_name);
                }
            });

            console.log(`å‡¦ç†å¾Œãƒ‡ãƒ¼ã‚¿ä»¶æ•°: ${allData.length}`);
            console.log(`éƒ½é“åºœçœŒæ•°: ${prefectures.size}`);
            console.log('éƒ½é“åºœçœŒãƒªã‚¹ãƒˆ:', Array.from(prefectures).sort());
            
            if (allData.length === 0) {
                throw new Error('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
            
            return allData;
            
        } catch (error) {
            console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            showError(`ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ã‚¨ãƒ©ãƒ¼: ${error.message}<br><br>japan_household_income_data.xlsxãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãé…ç½®ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            throw error;
        }
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
        document.getElementById('loading').style.display = 'none';
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = `
            <h3>âš ï¸ ã‚¨ãƒ©ãƒ¼</h3>
            <div>${message}</div>
            <button onclick="location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #c62828; color: white; border: none; border-radius: 5px; cursor: pointer;">å†èª­ã¿è¾¼ã¿</button>
            <button onclick="this.parentElement.remove()" style="margin-top: 15px; margin-left: 10px; padding: 8px 16px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">é–‰ã˜ã‚‹</button>
        `;
        document.body.appendChild(errorDiv);
    }

    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®ä½œæˆ
    function createHeatmap(data) {
        if (data.length === 0) {
            if (heatLayer) {
                map.removeLayer(heatLayer);
                heatLayer = null;
            }
            return;
        }

        const heatData = data.map(item => [
            item.latitude,
            item.longitude,
            Math.min(item.average_income / 1000, 1.2) // 0-1.2ã®ç¯„å›²ã«æ­£è¦åŒ–
        ]);

        if (heatLayer) {
            map.removeLayer(heatLayer);
        }

        heatLayer = L.heatLayer(heatData, {
            radius: 15,
            blur: 12,
            maxZoom: 17,
            max: 1.0,
            gradient: {
                0.0: '#313695',
                0.1: '#4575b4',
                0.2: '#74add1',
                0.3: '#abd9e9',
                0.4: '#e0f3f8',
                0.5: '#ffffbf',
                0.6: '#fee090',
                0.7: '#fdae61',
                0.8: '#f46d43',
                0.9: '#d73027',
                1.0: '#a50026'
            }
        }).addTo(map);
    }

    // ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆï¼ˆã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒé«˜ã„æ™‚ã®ã¿ï¼‰
    function createMarkers(data) {
        markerLayer.clearLayers();
        
        const zoom = map.getZoom();
        if (zoom < 9) return; // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒä½ã„æ™‚ã¯ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤ºã—ãªã„

        // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰
        const sampleSize = Math.min(data.length, 500);
        const sampledData = data.sort(() => 0.5 - Math.random()).slice(0, sampleSize);

        sampledData.forEach(item => {
            const marker = L.circleMarker([item.latitude, item.longitude], {
                radius: Math.max(3, Math.min(zoom - 5, 8)),
                fillColor: getColor(item.average_income),
                color: '#fff',
                weight: 1,
                opacity: 0.8,
                fillOpacity: 0.7
            });
            
            const popupContent = createPopupContent(item);
            marker.bindPopup(popupContent);
            markerLayer.addLayer(marker);
        });
    }

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä½œæˆ
    function createPopupContent(item) {
        const areaName = [
            item.prefecture_name,
            item.city_name,
            item.district_name,
            item.sub_area_name
        ].filter(name => name && name.trim()).join(' ');

        return `
            <div style="font-size: 13px; padding: 5px; min-width: 200px;">
                <strong style="font-size: 14px; color: #333;">${areaName || 'åœ°åŸŸæƒ…å ±ãªã—'}</strong><br>
                <div style="margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid ${getColor(item.average_income)};">
                    <span style="font-weight: bold; font-size: 16px; color: ${getColor(item.average_income)};">
                        ğŸ’° ${item.average_income}ä¸‡å††
                    </span>
                </div>
                ${item.population ? `ğŸ‘¥ äººå£: ${item.population.toLocaleString()}äºº<br>` : ''}
                ${item.household_count ? `ğŸ  ä¸–å¸¯æ•°: ${item.household_count.toLocaleString()}ä¸–å¸¯<br>` : ''}
                ${item.area_type ? `ğŸ¢ åœ°åŸŸã‚¿ã‚¤ãƒ—: ${item.area_type}<br>` : ''}
                <div style="margin-top: 5px; font-size: 11px; color: #666;">
                    ğŸ“ ${item.latitude.toFixed(4)}, ${item.longitude.toFixed(4)}
                </div>
            </div>
        `;
    }

    // ãƒ‡ãƒ¼ã‚¿ã®çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
    function updateStats(data) {
        const incomes = data.map(item => item.average_income).filter(income => income > 0);
        
        document.getElementById('dataPoints').textContent = data.length.toLocaleString();
        document.getElementById('prefectureCount').textContent = prefectures.size;
        
        if (incomes.length > 0) {
            const avgIncome = Math.round(incomes.reduce((sum, income) => sum + income, 0) / incomes.length);
            const maxIncome = Math.max(...incomes);
            const minIncome = Math.min(...incomes);
            
            document.getElementById('averageIncome').textContent = `${avgIncome}ä¸‡å††`;
            document.getElementById('maxIncome').textContent = `${maxIncome}ä¸‡å††`;
            document.getElementById('minIncome').textContent = `${minIncome}ä¸‡å††`;
        } else {
            document.getElementById('averageIncome').textContent = '-';
            document.getElementById('maxIncome').textContent = '-';
            document.getElementById('minIncome').textContent = '-';
        }
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®é©ç”¨
    function applyFilters() {
        const incomeFilter = document.getElementById('incomeFilter').value;
        const selectedPrefectures = Array.from(document.querySelectorAll('#prefectureFilter input:checked'))
            .map(checkbox => checkbox.value);

        filteredData = allData.filter(item => {
            // å¹´åãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            let incomeMatch = true;
            switch (incomeFilter) {
                case 'high':
                    incomeMatch = item.average_income >= 700;
                    break;
                case 'middle-high':
                    incomeMatch = item.average_income >= 550 && item.average_income < 700;
                    break;
                case 'middle':
                    incomeMatch = item.average_income >= 400 && item.average_income < 550;
                    break;
                case 'low':
                    incomeMatch = item.average_income < 400;
                    break;
            }

            // éƒ½é“åºœçœŒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const prefectureMatch = selectedPrefectures.length === 0 || 
                selectedPrefectures.includes(item.prefecture_name);

            return incomeMatch && prefectureMatch;
        });

        // è¡¨ç¤ºã‚’æ›´æ–°
        createHeatmap(filteredData);
        createMarkers(filteredData);
        updateStats(filteredData);
        
        console.log(`ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œ: ${filteredData.length}ä»¶è¡¨ç¤ºä¸­`);
    }

    // éƒ½é“åºœçœŒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UIã®ä½œæˆ
    function createPrefectureFilter() {
        const filterContainer = document.getElementById('prefectureFilter');
        const sortedPrefectures = Array.from(prefectures).sort();
        
        sortedPrefectures.forEach(prefecture => {
            const label = document.createElement('label');
            label.innerHTML = `
                <input type="checkbox" value="${prefecture}" checked> ${prefecture}
            `;
            filterContainer.appendChild(label);
        });

        // å…¨é¸æŠ/å…¨è§£é™¤ãƒœã‚¿ãƒ³ã®è¿½åŠ 
        const controlButtons = document.createElement('div');
        controlButtons.style.marginTop = '8px';
        controlButtons.style.textAlign = 'center';
        controlButtons.innerHTML = `
            <button onclick="toggleAllPrefectures(true)" style="font-size: 10px; margin: 2px; padding: 3px 8px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">å…¨é¸æŠ</button>
            <button onclick="toggleAllPrefectures(false)" style="font-size: 10px; margin: 2px; padding: 3px 8px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">å…¨è§£é™¤</button>
        `;
        filterContainer.appendChild(controlButtons);
    }

    // éƒ½é“åºœçœŒã®å…¨é¸æŠ/å…¨è§£é™¤
    function toggleAllPrefectures(selectAll) {
        const checkboxes = document.querySelectorAll('#prefectureFilter input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll;
        });
        applyFilters();
    }

    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®æŠ˜ã‚ŠãŸãŸã¿
    function toggleControls() {
        const content = document.getElementById('controlsContent');
        const btn = document.querySelector('.collapse-btn');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            btn.textContent = 'â”€';
        } else {
            content.style.display = 'none';
            btn.textContent = '+';
        }
    }

    // æƒ…å ±ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®è¿½åŠ 
    function addInfoControl() {
        const info = L.control();
        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };

        info.update = function () {
            this._div.innerHTML = '<h4>ğŸ—¾ æ—¥æœ¬å…¨å›½ä¸–å¸¯å¹´åãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</h4>' +
                '<div class="info-details">' +
                '<p><strong>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã®è¦‹æ–¹:</strong></p>' +
                '<p>ğŸ”´ èµ¤è‰²: é«˜æ‰€å¾—åœ°åŸŸ (700ä¸‡å††ä»¥ä¸Š)</p>' +
                '<p>ğŸŸ¡ é»„è‰²: ä¸­æ‰€å¾—åœ°åŸŸ (400-700ä¸‡å††)</p>' +
                '<p>ğŸ”µ é’è‰²: ä½æ‰€å¾—åœ°åŸŸ (400ä¸‡å††æœªæº€)</p>' +
                '<p><strong>ğŸ’¡ æ“ä½œæ–¹æ³•:</strong></p>' +
                '<p>â€¢ ã‚ºãƒ¼ãƒ ã‚¤ãƒ³: è©³ç´°ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º</p>' +
                '<p>â€¢ ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯: è©³ç´°æƒ…å ±è¡¨ç¤º</p>' +
                '<p>â€¢ å·¦ä¸Šãƒ‘ãƒãƒ«: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š</p>' +
                '<p style="margin-top: 8px; font-size: 10px; color: #666;">â€» ãƒ‡ãƒ¼ã‚¿ã¯çµ±è¨ˆã«åŸºã¥ãæ¨è¨ˆå€¤ã§ã™</p>' +
                '</div>';
        };

        info.addTo(map);
    }

    // å‡¡ä¾‹ã®è¿½åŠ 
    function addLegend() {
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            const grades = [0, 350, 400, 450, 500, 550, 600, 700, 800];
            
            div.innerHTML = '<h4 style="margin-bottom: 8px;">ä¸–å¸¯å¹´åï¼ˆä¸‡å††ï¼‰</h4>';
            
            for (let i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                    grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
            }
            
            return div;
        };
        legend.addTo(map);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    function setupEventListeners() {
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å¤‰æ›´æ™‚
        document.getElementById('incomeFilter').addEventListener('change', applyFilters);
        
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—å¼·åº¦ã®å¤‰æ›´æ™‚
        document.getElementById('heatIntensity').addEventListener('input', function(e) {
            if (heatLayer) {
                heatLayer.setOptions({
                    max: parseFloat(e.target.value)
                });
            }
        });

        // éƒ½é“åºœçœŒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å¤‰æ›´æ™‚
        document.addEventListener('change', function(e) {
            if (e.target.closest('#prefectureFilter')) {
                applyFilters();
            }
        });

        // ã‚ºãƒ¼ãƒ å¤‰æ›´æ™‚
        map.on('zoomend', function() {
            createMarkers(filteredData);
            
            // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’èª¿æ•´
            const zoom = map.getZoom();
            if (heatLayer) {
                if (zoom > 10) {
                    heatLayer.setOptions({radius: 8, blur: 6});
                } else if (zoom > 7) {
                    heatLayer.setOptions({radius: 12, blur: 9});
                } else {
                    heatLayer.setOptions({radius: 15, blur: 12});
                }
            }
        });

        // ãƒãƒƒãƒ—ç§»å‹•æ™‚
        map.on('moveend', function() {
            if (map.getZoom() >= 9) {
                createMarkers(filteredData);
            }
        });
    }

    // ãƒ¡ã‚¤ãƒ³å‡¦ç†
    async function main() {
        try {
            console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹');
            
            // åœ°å›³åˆæœŸåŒ–
            initializeMap();
            console.log('åœ°å›³åˆæœŸåŒ–å®Œäº†');
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            await loadData();
            console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
            
            // åˆæœŸè¡¨ç¤ºãƒ‡ãƒ¼ã‚¿ã®è¨­å®š
            filteredData = [...allData];
            
            // UIä½œæˆ
            createPrefectureFilter();
            addInfoControl();
            addLegend();
            console.log('UIä½œæˆå®Œäº†');
            
            // åˆæœŸè¡¨ç¤º
            createHeatmap(filteredData);
            createMarkers(filteredData);
            updateStats(filteredData);
            console.log('åˆæœŸè¡¨ç¤ºå®Œäº†');
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            setupEventListeners();
            console.log('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
            document.getElementById('loading').style.display = 'none';
            
            console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–å®Œäº†');
            console.log(`ç·ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: ${allData.length}, è¡¨ç¤ºä¸­: ${filteredData.length}`);
            
        } catch (error) {
            console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('loading').style.display = 'none';
        }
    }

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    document.addEventListener('DOMContentLoaded', main);
</script>
```

</body>
</html>
