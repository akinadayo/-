<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日本全国世帯年収ヒートマップ</title>

```
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        background: #f5f5f5;
    }
    
    #map {
        height: 100vh;
        width: 100%;
    }
    
    .info-popup {
        position: absolute;
        top: 80px;
        right: 20px;
        background: rgba(255,255,255,0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        min-width: 250px;
        font-size: 14px;
    }
    
    .info-popup h3 {
        margin: 0 0 10px 0;
        font-size: 16px;
        font-weight: bold;
    }
    
    .data-legend {
        margin-top: 10px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
        font-size: 13px;
    }
    
    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        border: 1px solid rgba(0,0,0,0.2);
    }
    
    .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 20px;
        height: 20px;
        line-height: 18px;
    }
    
    .close-btn:hover {
        color: #333;
    }
    
    .legend-box {
        position: absolute;
        bottom: 30px;
        right: 20px;
        background: rgba(255,255,255,0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        font-size: 12px;
        z-index: 1000;
    }
    
    .legend-box h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        font-weight: bold;
    }
    
    .legend-box .legend-item {
        display: flex;
        align-items: center;
        margin: 4px 0;
        font-size: 12px;
    }
    
    .legend-box .legend-color {
        width: 25px;
        height: 16px;
        margin-right: 8px;
        border-radius: 2px;
        border: 1px solid rgba(0,0,0,0.1);
    }
    
    .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px 50px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 2000;
        text-align: center;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        color: #d32f2f;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 2001;
        max-width: 400px;
        text-align: center;
    }
    
    .error-message h3 {
        margin: 0 0 10px 0;
        color: #d32f2f;
    }
    
    .error-message button {
        margin-top: 15px;
        padding: 8px 16px;
        background: #d32f2f;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .error-message button:hover {
        background: #b71c1c;
    }
</style>
```

</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>データを読み込み中...</div>
        <div style="font-size: 12px; margin-top: 8px; color: #666;">
            全国の世帯年収データを処理しています
        </div>
    </div>

```
<div id="map"></div>

<!-- データポイント統計 -->
<div class="info-popup" id="infoPopup">
    <button class="close-btn" onclick="this.parentElement.style.display='none'">×</button>
    <h3>📊 データポイント統計</h3>
    <div>総データポイント: <span id="totalPoints">0</span>個</div>
    <div class="data-legend">
        <h4 style="font-size: 14px; margin: 10px 0 5px 0;">データ表示</h4>
        <div class="legend-item">
            <div class="legend-color" style="background: #dc3545;"></div>
            <span>赤色: 高所得地域（600万円以上）</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ffc107;"></div>
            <span>黄色: 中所得地域（500-600万円）</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #28a745;"></div>
            <span>青色: 低所得地域（500万円未満）</span>
        </div>
    </div>
    <div style="margin-top: 10px; font-size: 11px; color: #666;">
        ※ マーカーをクリックで詳細表示<br>
        ※ ズームで詳細度が変化
    </div>
</div>

<!-- 凡例 -->
<div class="legend-box">
    <h4>世帯年収（万円）</h4>
    <div class="legend-item">
        <div class="legend-color" style="background: #800026;"></div>
        <span>650+</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #a50026;"></div>
        <span>600-650</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #d73027;"></div>
        <span>550-600</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #f46d43;"></div>
        <span>500-550</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #fdae61;"></div>
        <span>480-500</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #fee090;"></div>
        <span>450-480</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #ffffbf;"></div>
        <span>420-450</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #e0f3f8;"></div>
        <span>400-420</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #abd9e9;"></div>
        <span>0-400</span>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<!-- Leaflet Heat -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<!-- SheetJS for Excel reading -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    // グローバル変数
    let map;
    let heatLayer;
    let markerLayer;
    let allData = [];
    
    // 地図の初期化
    function initializeMap() {
        // 日本の中心座標（より正確な位置）
        map = L.map('map').setView([36.5, 138.0], 5.8);
        
        // OpenStreetMapタイルレイヤー
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18,
            minZoom: 4
        }).addTo(map);
        
        // マーカーレイヤーグループ
        markerLayer = L.layerGroup().addTo(map);
    }
    
    // カラースケール（画像の凡例に合わせた配色）
    function getColor(income) {
        return income >= 650 ? '#800026' :
               income >= 600 ? '#a50026' :
               income >= 550 ? '#d73027' :
               income >= 500 ? '#f46d43' :
               income >= 480 ? '#fdae61' :
               income >= 450 ? '#fee090' :
               income >= 420 ? '#ffffbf' :
               income >= 400 ? '#e0f3f8' :
                              '#abd9e9';
    }
    
    // XLSXファイルの読み込み
    async function loadData() {
        try {
            const response = await fetch('./japan_household_income_data.xlsx');
            
            if (!response.ok) {
                throw new Error(`ファイルが見つかりません: ${response.status}`);
            }
            
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            
            // 最初のシートを取得
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // JSONに変換
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            console.log('サンプルデータ:', jsonData[0]); // デバッグ用
            
            // データの処理（座標の順序に注意）
            allData = jsonData.map(row => {
                // 緯度と経度の列名をチェック（順序が逆になっている可能性を考慮）
                let lat = parseFloat(row.latitude || row['緯度'] || row.lat || 0);
                let lng = parseFloat(row.longitude || row['経度'] || row.lng || row.lon || 0);
                
                // 座標が逆になっている可能性をチェック
                // 日本の経度は約122-146、緯度は約24-46
                // もし緯度が100以上なら、緯度と経度が逆の可能性が高い
                if (lat > 100 && lng < 50) {
                    // 緯度と経度を入れ替える
                    const temp = lat;
                    lat = lng;
                    lng = temp;
                    console.log('座標を入れ替えました:', lat, lng);
                }
                
                const income = parseFloat(row.average_income || row['平均世帯年収'] || row['世帯年収'] || row.income || 0);
                
                return {
                    prefecture_name: row.prefecture_name || row['都道府県名'] || row['都道府県'] || '',
                    city_name: row.city_name || row['市区町村名'] || row['市区町村'] || '',
                    district_name: row.district_name || row['区名'] || row['地区名'] || '',
                    latitude: lat,
                    longitude: lng,
                    average_income: income,
                    population: parseInt(row.population || row['人口'] || 0),
                    household_count: parseInt(row.household_count || row['世帯数'] || 0)
                };
            }).filter(item => {
                // 日本の座標範囲内のデータのみ使用（より正確な範囲）
                const isValidCoords = item.latitude >= 20 && item.latitude <= 46 &&
                                    item.longitude >= 122 && item.longitude <= 154 &&
                                    item.average_income > 0;
                
                if (!isValidCoords && item.latitude !== 0) {
                    console.log('無効な座標:', item.latitude, item.longitude, item.prefecture_name);
                }
                
                return isValidCoords;
            });
            
            if (allData.length === 0) {
                throw new Error('有効なデータが見つかりませんでした');
            }
            
            console.log(`読み込み完了: ${allData.length}件のデータ`);
            // 収入の分布を確認
            const incomeRanges = {
                '0-400': allData.filter(d => d.average_income < 400).length,
                '400-500': allData.filter(d => d.average_income >= 400 && d.average_income < 500).length,
                '500-600': allData.filter(d => d.average_income >= 500 && d.average_income < 600).length,
                '600+': allData.filter(d => d.average_income >= 600).length
            };
            console.log('収入分布:', incomeRanges);
            
            return allData;
            
        } catch (error) {
            console.error('データ読み込みエラー:', error);
            throw error;
        }
    }
    
    // ヒートマップの作成
    function createHeatmap(data) {
        if (heatLayer) {
            map.removeLayer(heatLayer);
        }
        
        // ヒートマップ用データの準備（収入に応じて強度を設定）
        const heatData = data.map(item => {
            // 収入に基づいて強度を設定（低収入は低い値、高収入は高い値）
            let intensity;
            if (item.average_income < 400) {
                intensity = 0.2 + (item.average_income / 400) * 0.2; // 0.2-0.4
            } else if (item.average_income < 500) {
                intensity = 0.4 + ((item.average_income - 400) / 100) * 0.2; // 0.4-0.6
            } else if (item.average_income < 600) {
                intensity = 0.6 + ((item.average_income - 500) / 100) * 0.2; // 0.6-0.8
            } else {
                intensity = 0.8 + Math.min((item.average_income - 600) / 200, 0.2); // 0.8-1.0
            }
            return [item.latitude, item.longitude, intensity];
        });
        
        // ヒートマップレイヤーの作成（青→緑→黄→赤のグラデーション）
        heatLayer = L.heatLayer(heatData, {
            radius: 25,
            blur: 15,
            maxZoom: 12,
            max: 1.0,
            gradient: {
                0.0: 'rgba(0, 0, 255, 0)',      // 透明青
                0.2: 'rgba(0, 0, 255, 0.5)',    // 青（低収入）
                0.3: 'rgba(0, 128, 255, 0.6)',  // 水色
                0.4: 'rgba(0, 255, 255, 0.7)',  // シアン
                0.5: 'rgba(0, 255, 0, 0.8)',    // 緑
                0.6: 'rgba(255, 255, 0, 0.9)',  // 黄色（中収入）
                0.7: 'rgba(255, 200, 0, 0.9)',  // オレンジ黄
                0.8: 'rgba(255, 128, 0, 1)',    // オレンジ
                0.9: 'rgba(255, 0, 0, 1)',      // 赤（高収入）
                1.0: 'rgba(128, 0, 0, 1)'       // 濃い赤
            }
        }).addTo(map);
    }
    
    // マーカーの作成
    function createMarkers(data) {
        markerLayer.clearLayers();
        
        const zoom = map.getZoom();
        
        // ズームレベル8以上でマーカー表示
        if (zoom >= 8) {
            // 表示するデータを制限（パフォーマンス対策）
            const bounds = map.getBounds();
            const visibleData = data.filter(item => {
                return bounds.contains([item.latitude, item.longitude]);
            });
            
            // 最大500件まで表示
            const displayData = visibleData.slice(0, 500);
            
            displayData.forEach(item => {
                const color = getColor(item.average_income);
                
                const marker = L.circleMarker([item.latitude, item.longitude], {
                    radius: zoom >= 10 ? 8 : 6,
                    fillColor: color,
                    color: '#fff',
                    weight: 1.5,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                // ポップアップの内容
                const areaName = [
                    item.prefecture_name,
                    item.city_name,
                    item.district_name
                ].filter(name => name).join(' ');
                
                marker.bindPopup(`
                    <div style="font-size: 13px; min-width: 180px;">
                        <strong>${areaName || '地域情報'}</strong><br>
                        <div style="margin: 8px 0; padding: 5px; background: #f8f9fa; border-radius: 4px;">
                            <div style="font-size: 16px; font-weight: bold; color: ${color};">
                                ${item.average_income.toFixed(0)}万円
                            </div>
                        </div>
                        ${item.population ? `人口: ${item.population.toLocaleString()}人<br>` : ''}
                        ${item.household_count ? `世帯数: ${item.household_count.toLocaleString()}世帯` : ''}
                    </div>
                `);
                
                markerLayer.addLayer(marker);
            });
        }
    }
    
    // エラー表示
    function showError(message) {
        document.getElementById('loading').style.display = 'none';
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = `
            <h3>⚠️ エラー</h3>
            <div>${message}</div>
            <button onclick="location.reload()">再読み込み</button>
        `;
        document.body.appendChild(errorDiv);
    }
    
    // データポイント数の更新
    function updateDataPoints(count) {
        const pointsElement = document.getElementById('totalPoints');
        if (pointsElement) {
            pointsElement.textContent = count.toLocaleString();
        }
    }
    
    // イベントリスナーの設定
    function setupEventListeners() {
        // ズーム変更時の処理
        map.on('zoomend', function() {
            const zoom = map.getZoom();
            
            // ズームレベルに応じてヒートマップの設定を調整
            if (heatLayer) {
                if (zoom >= 10) {
                    heatLayer.setOptions({radius: 12, blur: 8});
                } else if (zoom >= 8) {
                    heatLayer.setOptions({radius: 18, blur: 12});
                } else if (zoom >= 6) {
                    heatLayer.setOptions({radius: 22, blur: 15});
                } else {
                    heatLayer.setOptions({radius: 25, blur: 15});
                }
            }
            
            // マーカーの更新
            createMarkers(allData);
        });
        
        // 地図移動時
        map.on('moveend', function() {
            if (map.getZoom() >= 8) {
                createMarkers(allData);
            }
        });
    }
    
    // メイン処理
    async function main() {
        try {
            // 地図の初期化
            initializeMap();
            
            // データの読み込み
            const data = await loadData();
            
            // データポイント数の表示
            updateDataPoints(data.length);
            
            // ヒートマップの作成
            createHeatmap(data);
            
            // マーカーの作成（初期ズームレベルに応じて）
            createMarkers(data);
            
            // イベントリスナーの設定
            setupEventListeners();
            
            // ローディング画面を非表示
            document.getElementById('loading').style.display = 'none';
            
            // 5秒後に情報ポップアップを自動で閉じる
            setTimeout(() => {
                const popup = document.getElementById('infoPopup');
                if (popup) {
                    popup.style.display = 'none';
                }
            }, 5000);
            
        } catch (error) {
            showError('データファイルの読み込みに失敗しました。<br>japan_household_income_data.xlsxファイルを確認してください。');
        }
    }
    
    // ページ読み込み完了後に実行
    document.addEventListener('DOMContentLoaded', main);
</script>
```

</body>
</html>