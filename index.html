<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日本全国世帯年収ヒートマップ - GeoJSON版</title>

```
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        background: #f5f5f5;
    }
    
    #map {
        height: 100vh;
        width: 100%;
    }
    
    .control-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255,255,255,0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        min-width: 250px;
    }
    
    .control-panel h3 {
        margin: 0 0 10px 0;
        font-size: 16px;
        color: #333;
    }
    
    .control-item {
        margin: 10px 0;
    }
    
    .control-item label {
        display: block;
        font-size: 13px;
        color: #666;
        margin-bottom: 5px;
    }
    
    .control-item select,
    .control-item input {
        width: 100%;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
    }
    
    .toggle-buttons {
        display: flex;
        gap: 5px;
        margin: 10px 0;
    }
    
    .toggle-btn {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s;
    }
    
    .toggle-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .toggle-btn:hover:not(.active) {
        background: #f0f0f0;
    }
    
    .info-box {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255,255,255,0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        max-width: 300px;
    }
    
    .info-box h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #333;
    }
    
    .stats-item {
        margin: 5px 0;
        font-size: 12px;
        color: #666;
    }
    
    .legend {
        position: absolute;
        bottom: 30px;
        right: 10px;
        background: rgba(255,255,255,0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
    }
    
    .legend h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #333;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
        font-size: 12px;
    }
    
    .legend-color {
        width: 20px;
        height: 15px;
        margin-right: 8px;
        border: 1px solid #ccc;
    }
    
    .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px 50px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 2000;
        text-align: center;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        color: #d32f2f;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 2001;
        max-width: 400px;
        text-align: center;
    }
    
    .popup-content {
        font-size: 13px;
        line-height: 1.5;
    }
    
    .popup-content h5 {
        margin: 0 0 8px 0;
        font-size: 14px;
        color: #333;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
    }
    
    .popup-content .income-value {
        font-size: 18px;
        font-weight: bold;
        color: #007bff;
        margin: 10px 0;
    }
    
    .popup-content .detail-item {
        margin: 3px 0;
        font-size: 12px;
        color: #666;
    }
</style>
```

</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>データを読み込み中...</div>
        <div style="font-size: 12px; margin-top: 8px; color: #666;">
            世帯年収データとGeoJSONを処理しています
        </div>
    </div>

```
<div id="map"></div>

<!-- コントロールパネル -->
<div class="control-panel">
    <h3>🎛️ 表示設定</h3>
    
    <div class="control-item">
        <label>表示レベル</label>
        <div class="toggle-buttons">
            <button class="toggle-btn active" id="btnMunicipality" onclick="switchDataLevel('municipality')">
                市区町村
            </button>
            <button class="toggle-btn" id="btnSmallArea" onclick="switchDataLevel('smallarea')">
                小地域
            </button>
        </div>
    </div>
    
    <div class="control-item">
        <label>データ表示項目</label>
        <select id="dataField" onchange="updateDataField()">
            <option value="income">世帯年収（万円）</option>
            <option value="taxable">課税対象所得（千円）</option>
        </select>
    </div>
    
    <div class="control-item">
        <label>都道府県フィルター</label>
        <select id="prefectureFilter" onchange="filterByPrefecture()">
            <option value="">全国</option>
        </select>
    </div>
    
    <div class="control-item">
        <label>透明度</label>
        <input type="range" id="opacity" min="0.1" max="1" step="0.1" value="0.7" onchange="updateOpacity()">
    </div>
</div>

<!-- 情報ボックス -->
<div class="info-box">
    <h4>📊 データ統計</h4>
    <div class="stats-item">
        <strong>表示レベル:</strong> <span id="currentLevel">市区町村</span>
    </div>
    <div class="stats-item">
        <strong>データ件数:</strong> <span id="dataCount">0</span>件
    </div>
    <div class="stats-item">
        <strong>平均世帯年収:</strong> <span id="avgIncome">-</span>万円
    </div>
    <div class="stats-item">
        <strong>最高値:</strong> <span id="maxIncome">-</span>万円
    </div>
    <div class="stats-item">
        <strong>最低値:</strong> <span id="minIncome">-</span>万円
    </div>
</div>

<!-- 凡例 -->
<div class="legend">
    <h4>世帯年収（万円）</h4>
    <div class="legend-item">
        <div class="legend-color" style="background: #800026;"></div>
        <span>700以上</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #BD0026;"></div>
        <span>600-700</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #E31A1C;"></div>
        <span>550-600</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #FC4E2A;"></div>
        <span>500-550</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #FD8D3C;"></div>
        <span>450-500</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #FEB24C;"></div>
        <span>400-450</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #FED976;"></div>
        <span>350-400</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #FFEDA0;"></div>
        <span>300-350</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #FFFFCC;"></div>
        <span>300未満</span>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<!-- SheetJS for Excel reading -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    // グローバル変数
    let map;
    let currentGeoJSONLayer;
    let incomeData = {};
    let municipalityData = {};
    let smallAreaData = {};
    let currentDataLevel = 'municipality';
    let currentDataField = 'income';
    let geoJSONData = {
        municipality: null,
        smallarea: null
    };
    
    // 地図の初期化
    function initializeMap() {
        map = L.map('map').setView([36.5, 138.0], 5);
        
        // OpenStreetMapタイルレイヤー
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18,
            minZoom: 4
        }).addTo(map);
    }
    
    // カラースケール
    function getColor(value) {
        if (!value) return '#CCCCCC';
        
        return value >= 700 ? '#800026' :
               value >= 600 ? '#BD0026' :
               value >= 550 ? '#E31A1C' :
               value >= 500 ? '#FC4E2A' :
               value >= 450 ? '#FD8D3C' :
               value >= 400 ? '#FEB24C' :
               value >= 350 ? '#FED976' :
               value >= 300 ? '#FFEDA0' :
                              '#FFFFCC';
    }
    
    // Excelデータの読み込み
    async function loadIncomeData() {
        try {
            const response = await fetch('./comprehensive_japanese_household_income_dataset_12k.xlsx');
            
            if (!response.ok) {
                throw new Error(`ファイルが見つかりません: ${response.status}`);
            }
            
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            console.log('データサンプル:', jsonData.slice(0, 3));
            
            // データを処理して市区町村と小地域に分類
            jsonData.forEach(row => {
                const prefCode = String(row['JIS都道府県コード'] || '').padStart(2, '0');
                const cityCode = String(row['JIS市区町村コード'] || '');
                const smallCode = String(row['小地域コード'] || '');
                const income = parseFloat(row['世帯年収_万円']) || 0;
                const taxable = parseFloat(row['課税対象所得_千円']) || 0;
                
                if (cityCode) {
                    // 6桁コード（市区町村）
                    const code6 = prefCode + cityCode.padStart(4, '0');
                    municipalityData[code6] = {
                        prefecture: row['都道府県名'],
                        city: row['市区町村名'],
                        income: income,
                        taxable: taxable,
                        households: parseInt(row['推定世帯数']) || 0,
                        year: row['データ年度'],
                        source: row['データソース']
                    };
                }
                
                if (smallCode) {
                    // 11桁コード（小地域）
                    const code11 = prefCode + cityCode.padStart(4, '0') + smallCode.padStart(5, '0');
                    smallAreaData[code11] = {
                        prefecture: row['都道府県名'],
                        city: row['市区町村名'],
                        area: row['小地域名'],
                        income: income,
                        taxable: taxable,
                        households: parseInt(row['推定世帯数']) || 0,
                        year: row['データ年度'],
                        source: row['データソース']
                    };
                }
            });
            
            console.log('市区町村データ数:', Object.keys(municipalityData).length);
            console.log('小地域データ数:', Object.keys(smallAreaData).length);
            
            // 都道府県リストを作成
            const prefectures = new Set();
            Object.values(municipalityData).forEach(data => {
                if (data.prefecture) prefectures.add(data.prefecture);
            });
            
            const prefSelect = document.getElementById('prefectureFilter');
            Array.from(prefectures).sort().forEach(pref => {
                const option = document.createElement('option');
                option.value = pref;
                option.textContent = pref;
                prefSelect.appendChild(option);
            });
            
            updateStatistics();
            
        } catch (error) {
            console.error('データ読み込みエラー:', error);
            throw error;
        }
    }
    
    // GeoJSONの読み込み
    async function loadGeoJSON() {
        try {
            // 市区町村GeoJSON（N03など国土数値情報のGeoJSON）
            // ここでは仮のURLを使用。実際のGeoJSONファイルのパスに置き換えてください
            const municipalityResponse = await fetch('./municipalities.geojson');
            if (municipalityResponse.ok) {
                geoJSONData.municipality = await municipalityResponse.json();
                console.log('市区町村GeoJSON読み込み完了');
            }
        } catch (error) {
            console.warn('GeoJSON読み込みエラー:', error);
            // GeoJSONが無い場合はポイントデータとして表示
            createPointData();
        }
    }
    
    // GeoJSONレイヤーの作成
    function createGeoJSONLayer(level) {
        if (currentGeoJSONLayer) {
            map.removeLayer(currentGeoJSONLayer);
        }
        
        const dataSource = level === 'municipality' ? municipalityData : smallAreaData;
        const geoJSON = geoJSONData[level];
        
        if (!geoJSON) {
            // GeoJSONが無い場合はポイントマーカーで表示
            createPointMarkers(dataSource);
            return;
        }
        
        currentGeoJSONLayer = L.geoJSON(geoJSON, {
            style: feature => {
                const code = feature.properties.localgov_code || 
                            feature.properties.N03_007 || 
                            feature.properties.code;
                
                const data = dataSource[code];
                const value = data ? 
                    (currentDataField === 'income' ? data.income : data.taxable / 1000) : 
                    null;
                
                return {
                    fillColor: getColor(value),
                    weight: 1,
                    opacity: 1,
                    color: '#666',
                    fillOpacity: parseFloat(document.getElementById('opacity').value)
                };
            },
            onEachFeature: (feature, layer) => {
                const code = feature.properties.localgov_code || 
                           feature.properties.N03_007 || 
                           feature.properties.code;
                
                const data = dataSource[code];
                
                if (data) {
                    const popupContent = `
                        <div class="popup-content">
                            <h5>${data.prefecture} ${data.city}${data.area ? ' ' + data.area : ''}</h5>
                            <div class="income-value">${data.income.toFixed(1)}万円</div>
                            <div class="detail-item">課税対象所得: ${data.taxable.toLocaleString()}千円</div>
                            <div class="detail-item">推定世帯数: ${data.households.toLocaleString()}世帯</div>
                            <div class="detail-item">データ年度: ${data.year}年</div>
                            <div class="detail-item">ソース: ${data.source}</div>
                        </div>
                    `;
                    layer.bindPopup(popupContent);
                }
                
                // ホバー時のハイライト
                layer.on({
                    mouseover: e => {
                        e.target.setStyle({
                            weight: 3,
                            color: '#333',
                            fillOpacity: 0.9
                        });
                    },
                    mouseout: e => {
                        currentGeoJSONLayer.resetStyle(e.target);
                    }
                });
            }
        }).addTo(map);
    }
    
    // ポイントマーカーの作成（GeoJSONが無い場合のフォールバック）
    function createPointMarkers(dataSource) {
        if (currentGeoJSONLayer) {
            map.removeLayer(currentGeoJSONLayer);
        }
        
        currentGeoJSONLayer = L.layerGroup();
        
        // 都道府県中心座標（仮データ）
        const prefectureCoords = {
            '北海道': [43.0642, 141.3469],
            '青森県': [40.8244, 140.7400],
            '岩手県': [39.7036, 141.1527],
            '宮城県': [38.2682, 140.8722],
            '秋田県': [39.7186, 140.1024],
            '山形県': [38.2404, 140.3637],
            '福島県': [37.7503, 140.4678],
            '茨城県': [36.3418, 140.4468],
            '栃木県': [36.5657, 139.8836],
            '群馬県': [36.3911, 139.0608],
            '埼玉県': [35.8617, 139.6455],
            '千葉県': [35.6074, 140.1065],
            '東京都': [35.6762, 139.6503],
            '神奈川県': [35.4478, 139.6425],
            '新潟県': [37.9022, 139.0235],
            '富山県': [36.6953, 137.2113],
            '石川県': [36.5947, 136.6256],
            '福井県': [36.0652, 136.2219],
            '山梨県': [35.6640, 138.5683],
            '長野県': [36.6513, 138.1809],
            '岐阜県': [35.3912, 136.7223],
            '静岡県': [34.9769, 138.3831],
            '愛知県': [35.1802, 136.9065],
            '三重県': [34.7303, 136.5086],
            '滋賀県': [35.0045, 135.8686],
            '京都府': [35.0213, 135.7556],
            '大阪府': [34.6863, 135.5200],
            '兵庫県': [34.6901, 135.1830],
            '奈良県': [34.6851, 135.8329],
            '和歌山県': [34.2260, 135.1675],
            '鳥取県': [35.5039, 134.2378],
            '島根県': [35.4723, 133.0505],
            '岡山県': [34.6617, 133.9350],
            '広島県': [34.3966, 132.4596],
            '山口県': [34.1859, 131.4705],
            '徳島県': [34.0658, 134.5593],
            '香川県': [34.3401, 134.0434],
            '愛媛県': [33.8416, 132.7657],
            '高知県': [33.5597, 133.5311],
            '福岡県': [33.6064, 130.4183],
            '佐賀県': [33.2494, 130.2988],
            '長崎県': [32.7448, 129.8737],
            '熊本県': [32.7898, 130.7417],
            '大分県': [33.2382, 131.6126],
            '宮崎県': [31.9111, 131.4239],
            '鹿児島県': [31.5602, 130.5581],
            '沖縄県': [26.2124, 127.6809]
        };
        
        Object.entries(dataSource).forEach(([code, data]) => {
            if (!data.income) return;
            
            // 都道府県の座標を基準に少しランダムにずらす
            const baseCoords = prefectureCoords[data.prefecture];
            if (!baseCoords) return;
            
            const lat = baseCoords[0] + (Math.random() - 0.5) * 0.5;
            const lng = baseCoords[1] + (Math.random() - 0.5) * 0.5;
            
            const value = currentDataField === 'income' ? data.income : data.taxable / 1000;
            const color = getColor(value);
            
            const marker = L.circleMarker([lat, lng], {
                radius: 6,
                fillColor: color,
                color: '#fff',
                weight: 1,
                opacity: 1,
                fillOpacity: parseFloat(document.getElementById('opacity').value)
            });
            
            const popupContent = `
                <div class="popup-content">
                    <h5>${data.prefecture} ${data.city}${data.area ? ' ' + data.area : ''}</h5>
                    <div class="income-value">${data.income.toFixed(1)}万円</div>
                    <div class="detail-item">課税対象所得: ${data.taxable.toLocaleString()}千円</div>
                    <div class="detail-item">推定世帯数: ${data.households.toLocaleString()}世帯</div>
                    <div class="detail-item">データ年度: ${data.year}年</div>
                    <div class="detail-item">ソース: ${data.source}</div>
                </div>
            `;
            marker.bindPopup(popupContent);
            
            currentGeoJSONLayer.addLayer(marker);
        });
        
        currentGeoJSONLayer.addTo(map);
    }
    
    // データレベルの切り替え
    function switchDataLevel(level) {
        currentDataLevel = level;
        
        // ボタンのアクティブ状態を更新
        document.getElementById('btnMunicipality').classList.toggle('active', level === 'municipality');
        document.getElementById('btnSmallArea').classList.toggle('active', level === 'smallarea');
        
        // 表示を更新
        document.getElementById('currentLevel').textContent = level === 'municipality' ? '市区町村' : '小地域';
        
        // レイヤーを再作成
        createGeoJSONLayer(level);
        updateStatistics();
    }
    
    // データフィールドの更新
    function updateDataField() {
        currentDataField = document.getElementById('dataField').value;
        createGeoJSONLayer(currentDataLevel);
    }
    
    // 透明度の更新
    function updateOpacity() {
        const opacity = parseFloat(document.getElementById('opacity').value);
        
        if (currentGeoJSONLayer) {
            if (currentGeoJSONLayer instanceof L.GeoJSON) {
                currentGeoJSONLayer.setStyle({ fillOpacity: opacity });
            } else {
                currentGeoJSONLayer.eachLayer(layer => {
                    if (layer.setStyle) {
                        layer.setStyle({ fillOpacity: opacity });
                    }
                });
            }
        }
    }
    
    // 都道府県フィルター
    function filterByPrefecture() {
        const selectedPref = document.getElementById('prefectureFilter').value;
        
        if (selectedPref) {
            // 選択された都道府県のデータのみ表示
            const filteredData = {};
            const dataSource = currentDataLevel === 'municipality' ? municipalityData : smallAreaData;
            
            Object.entries(dataSource).forEach(([code, data]) => {
                if (data.prefecture === selectedPref) {
                    filteredData[code] = data;
                }
            });
            
            // フィルタリングされたデータで再描画
            if (geoJSONData[currentDataLevel]) {
                // GeoJSONの場合
                createGeoJSONLayer(currentDataLevel);
            } else {
                // ポイントマーカーの場合
                createPointMarkers(filteredData);
            }
        } else {
            // 全国表示
            createGeoJSONLayer(currentDataLevel);
        }
    }
    
    // 統計情報の更新
    function updateStatistics() {
        const dataSource = currentDataLevel === 'municipality' ? municipalityData : smallAreaData;
        const values = Object.values(dataSource)
            .map(d => d.income)
            .filter(v => v > 0);
        
        if (values.length > 0) {
            const avg = values.reduce((sum, v) => sum + v, 0) / values.length;
            const max = Math.max(...values);
            const min = Math.min(...values);
            
            document.getElementById('dataCount').textContent = values.length.toLocaleString();
            document.getElementById('avgIncome').textContent = avg.toFixed(1);
            document.getElementById('maxIncome').textContent = max.toFixed(1);
            document.getElementById('minIncome').textContent = min.toFixed(1);
        } else {
            document.getElementById('dataCount').textContent = '0';
            document.getElementById('avgIncome').textContent = '-';
            document.getElementById('maxIncome').textContent = '-';
            document.getElementById('minIncome').textContent = '-';
        }
    }
    
    // エラー表示
    function showError(message) {
        document.getElementById('loading').style.display = 'none';
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = `
            <h3>⚠️ エラー</h3>
            <div>${message}</div>
            <button onclick="location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                再読み込み
            </button>
        `;
        document.body.appendChild(errorDiv);
    }
    
    // メイン処理
    async function main() {
        try {
            // 地図の初期化
            initializeMap();
            
            // データの読み込み
            await loadIncomeData();
            
            // GeoJSONの読み込み（オプション）
            await loadGeoJSON();
            
            // 初期表示（市区町村レベル）
            createGeoJSONLayer('municipality');
            
            // ローディング画面を非表示
            document.getElementById('loading').style.display = 'none';
            
        } catch (error) {
            console.error('初期化エラー:', error);
            showError('データの読み込みに失敗しました。<br>ファイルを確認してください。');
        }
    }
    
    // ページ読み込み完了後に実行
    document.addEventListener('DOMContentLoaded', main);
</script>
```

</body>
</html>