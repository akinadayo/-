<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬å…¨å›½ä¸–å¸¯å¹´åãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</title>

```
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        background: #f5f5f5;
    }
    
    #map {
        height: 100vh;
        width: 100%;
    }
    
    .control-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255,255,255,0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        min-width: 250px;
    }
    
    .control-panel h3 {
        margin: 0 0 10px 0;
        font-size: 16px;
        color: #333;
    }
    
    .control-item {
        margin: 10px 0;
    }
    
    .control-item label {
        display: block;
        font-size: 13px;
        color: #666;
        margin-bottom: 5px;
    }
    
    .control-item select,
    .control-item input {
        width: 100%;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
    }
    
    .toggle-buttons {
        display: flex;
        gap: 5px;
        margin: 10px 0;
    }
    
    .toggle-btn {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s;
    }
    
    .toggle-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .toggle-btn:hover:not(.active) {
        background: #f0f0f0;
    }
    
    .info-box {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255,255,255,0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        max-width: 300px;
    }
    
    .info-box h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #333;
    }
    
    .stats-item {
        margin: 5px 0;
        font-size: 12px;
        color: #666;
    }
    
    .legend {
        position: absolute;
        bottom: 30px;
        right: 10px;
        background: rgba(255,255,255,0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
    }
    
    .legend h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #333;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
        font-size: 12px;
    }
    
    .legend-color {
        width: 20px;
        height: 15px;
        margin-right: 8px;
        border: 1px solid #ccc;
    }
    
    .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px 50px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 2000;
        text-align: center;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .popup-content {
        font-size: 13px;
        line-height: 1.5;
    }
    
    .popup-content h5 {
        margin: 0 0 8px 0;
        font-size: 14px;
        color: #333;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
    }
    
    .popup-content .income-value {
        font-size: 18px;
        font-weight: bold;
        color: #007bff;
        margin: 10px 0;
    }
</style>
```

</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        <div style="font-size: 12px; margin-top: 8px; color: #666;">
            ä¸–å¸¯å¹´åãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¦ã„ã¾ã™
        </div>
    </div>

```
<div id="map"></div>

<!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
<div class="control-panel">
    <h3>ğŸ›ï¸ è¡¨ç¤ºè¨­å®š</h3>
    
    <div class="control-item">
        <label>è¡¨ç¤ºãƒ¬ãƒ™ãƒ«</label>
        <div class="toggle-buttons">
            <button class="toggle-btn active" id="btnMunicipality" onclick="switchDataLevel('municipality')">
                å¸‚åŒºç”ºæ‘
            </button>
            <button class="toggle-btn" id="btnSmallArea" onclick="switchDataLevel('smallarea')">
                å°åœ°åŸŸ
            </button>
        </div>
    </div>
    
    <div class="control-item">
        <label>ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºé …ç›®</label>
        <select id="dataField" onchange="updateDataField()">
            <option value="income">ä¸–å¸¯å¹´åï¼ˆä¸‡å††ï¼‰</option>
            <option value="taxable">èª²ç¨å¯¾è±¡æ‰€å¾—ï¼ˆåƒå††ï¼‰</option>
        </select>
    </div>
    
    <div class="control-item">
        <label>éƒ½é“åºœçœŒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
        <select id="prefectureFilter" onchange="filterByPrefecture()">
            <option value="">å…¨å›½</option>
        </select>
    </div>
    
    <div class="control-item">
        <label>é€æ˜åº¦</label>
        <input type="range" id="opacity" min="0.1" max="1" step="0.1" value="0.7" onchange="updateOpacity()">
    </div>
</div>

<!-- æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ -->
<div class="info-box">
    <h4>ğŸ“Š ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ</h4>
    <div class="stats-item">
        <strong>è¡¨ç¤ºãƒ¬ãƒ™ãƒ«:</strong> <span id="currentLevel">å¸‚åŒºç”ºæ‘</span>
    </div>
    <div class="stats-item">
        <strong>ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:</strong> <span id="dataCount">0</span>ä»¶
    </div>
    <div class="stats-item">
        <strong>å¹³å‡ä¸–å¸¯å¹´å:</strong> <span id="avgIncome">-</span>ä¸‡å††
    </div>
    <div class="stats-item">
        <strong>æœ€é«˜å€¤:</strong> <span id="maxIncome">-</span>ä¸‡å††
    </div>
    <div class="stats-item">
        <strong>æœ€ä½å€¤:</strong> <span id="minIncome">-</span>ä¸‡å††
    </div>
</div>

<!-- å‡¡ä¾‹ -->
<div class="legend">
    <h4>ä¸–å¸¯å¹´åï¼ˆä¸‡å††ï¼‰</h4>
    <div class="legend-item">
        <div class="legend-color" style="background: #800026;"></div>
        <span>700ä»¥ä¸Š</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #BD0026;"></div>
        <span>600-700</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #E31A1C;"></div>
        <span>550-600</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #FC4E2A;"></div>
        <span>500-550</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #FD8D3C;"></div>
        <span>450-500</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #FEB24C;"></div>
        <span>400-450</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #FED976;"></div>
        <span>350-400</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #FFEDA0;"></div>
        <span>300-350</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #FFFFCC;"></div>
        <span>300æœªæº€</span>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<!-- Leaflet Heat ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<!-- SheetJS for Excel reading -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let map;
    let heatmapLayer;
    let markerLayer;
    let municipalityData = {};
    let smallAreaData = {};
    let currentDataLevel = 'municipality';
    let currentDataField = 'income';
    
    // å¸‚åŒºç”ºæ‘ã®ä¸­å¿ƒåº§æ¨™ãƒ‡ãƒ¼ã‚¿ï¼ˆä¸»è¦éƒ½å¸‚ï¼‰
    const cityCoordinates = {
        // æ±äº¬23åŒº
        '13101': {lat: 35.6894, lng: 139.6917, name: 'åƒä»£ç”°åŒº'},
        '13102': {lat: 35.6595, lng: 139.7291, name: 'æ¸¯åŒº'},
        '13103': {lat: 35.6938, lng: 139.7034, name: 'æ–°å®¿åŒº'},
        '13104': {lat: 35.7295, lng: 139.7109, name: 'æ–‡äº¬åŒº'},
        '13105': {lat: 35.7066, lng: 139.7746, name: 'å°æ±åŒº'},
        '13106': {lat: 35.6959, lng: 139.8140, name: 'å¢¨ç”°åŒº'},
        '13107': {lat: 35.6828, lng: 139.8090, name: 'æ±Ÿæ±åŒº'},
        '13108': {lat: 35.6228, lng: 139.7228, name: 'å“å·åŒº'},
        '13109': {lat: 35.6332, lng: 139.7016, name: 'ç›®é»’åŒº'},
        '13110': {lat: 35.6020, lng: 139.6685, name: 'å¤§ç”°åŒº'},
        '13111': {lat: 35.6368, lng: 139.6534, name: 'ä¸–ç”°è°·åŒº'},
        '13112': {lat: 35.6640, lng: 139.6982, name: 'æ¸‹è°·åŒº'},
        '13113': {lat: 35.7061, lng: 139.6514, name: 'ä¸­é‡åŒº'},
        '13114': {lat: 35.7378, lng: 139.6289, name: 'æ‰ä¸¦åŒº'},
        '13115': {lat: 35.7320, lng: 139.7155, name: 'è±Šå³¶åŒº'},
        '13116': {lat: 35.7430, lng: 139.7394, name: 'åŒ—åŒº'},
        '13117': {lat: 35.7380, lng: 139.7619, name: 'è’å·åŒº'},
        '13118': {lat: 35.7514, lng: 139.6795, name: 'æ¿æ©‹åŒº'},
        '13119': {lat: 35.7522, lng: 139.6116, name: 'ç·´é¦¬åŒº'},
        '13120': {lat: 35.7756, lng: 139.8045, name: 'è¶³ç«‹åŒº'},
        '13121': {lat: 35.7493, lng: 139.8472, name: 'è‘›é£¾åŒº'},
        '13122': {lat: 35.6732, lng: 139.8741, name: 'æ±Ÿæˆ¸å·åŒº'},
        // ä»–ã®ä¸»è¦éƒ½å¸‚
        '14100': {lat: 35.4478, lng: 139.6425, name: 'æ¨ªæµœå¸‚'},
        '23100': {lat: 35.1802, lng: 136.9065, name: 'åå¤å±‹å¸‚'},
        '27100': {lat: 34.6937, lng: 135.5023, name: 'å¤§é˜ªå¸‚'},
        '40100': {lat: 33.6064, lng: 130.4183, name: 'ç¦å²¡å¸‚'},
        '01100': {lat: 43.0642, lng: 141.3469, name: 'æœ­å¹Œå¸‚'}
    };
    
    // åœ°å›³ã®åˆæœŸåŒ–
    function initializeMap() {
        map = L.map('map').setView([36.5, 138.0], 5);
        
        // OpenStreetMapã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 18,
            minZoom: 4
        }).addTo(map);
        
        // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã®åˆæœŸåŒ–
        markerLayer = L.layerGroup();
    }
    
    // ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«
    function getColor(value) {
        if (!value) return '#CCCCCC';
        
        return value >= 700 ? '#800026' :
               value >= 600 ? '#BD0026' :
               value >= 550 ? '#E31A1C' :
               value >= 500 ? '#FC4E2A' :
               value >= 450 ? '#FD8D3C' :
               value >= 400 ? '#FEB24C' :
               value >= 350 ? '#FED976' :
               value >= 300 ? '#FFEDA0' :
                              '#FFFFCC';
    }
    
    // å¸‚åŒºç”ºæ‘ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åº§æ¨™ã‚’å–å¾—
    function getCoordinatesForCity(cityCode, cityName, prefName) {
        // æ—¢çŸ¥ã®åº§æ¨™ãŒã‚ã‚Œã°ä½¿ç”¨
        if (cityCoordinates[cityCode]) {
            return cityCoordinates[cityCode];
        }
        
        // éƒ½é“åºœçœŒã®ä¸­å¿ƒåº§æ¨™ã‚’ãƒ™ãƒ¼ã‚¹ã«æ¨å®š
        const prefCoords = {
            'åŒ—æµ·é“': {lat: 43.0642, lng: 141.3469},
            'é’æ£®çœŒ': {lat: 40.8244, lng: 140.7400},
            'å²©æ‰‹çœŒ': {lat: 39.7036, lng: 141.1527},
            'å®®åŸçœŒ': {lat: 38.2682, lng: 140.8722},
            'ç§‹ç”°çœŒ': {lat: 39.7186, lng: 140.1024},
            'å±±å½¢çœŒ': {lat: 38.2404, lng: 140.3637},
            'ç¦å³¶çœŒ': {lat: 37.7503, lng: 140.4678},
            'èŒ¨åŸçœŒ': {lat: 36.3418, lng: 140.4468},
            'æ ƒæœ¨çœŒ': {lat: 36.5657, lng: 139.8836},
            'ç¾¤é¦¬çœŒ': {lat: 36.3911, lng: 139.0608},
            'åŸ¼ç‰çœŒ': {lat: 35.8617, lng: 139.6455},
            'åƒè‘‰çœŒ': {lat: 35.6074, lng: 140.1065},
            'æ±äº¬éƒ½': {lat: 35.6762, lng: 139.6503},
            'ç¥å¥ˆå·çœŒ': {lat: 35.4478, lng: 139.6425},
            'æ–°æ½ŸçœŒ': {lat: 37.9022, lng: 139.0235},
            'å¯Œå±±çœŒ': {lat: 36.6953, lng: 137.2113},
            'çŸ³å·çœŒ': {lat: 36.5947, lng: 136.6256},
            'ç¦äº•çœŒ': {lat: 36.0652, lng: 136.2219},
            'å±±æ¢¨çœŒ': {lat: 35.6640, lng: 138.5683},
            'é•·é‡çœŒ': {lat: 36.6513, lng: 138.1809},
            'å²é˜œçœŒ': {lat: 35.3912, lng: 136.7223},
            'é™å²¡çœŒ': {lat: 34.9769, lng: 138.3831},
            'æ„›çŸ¥çœŒ': {lat: 35.1802, lng: 136.9065},
            'ä¸‰é‡çœŒ': {lat: 34.7303, lng: 136.5086},
            'æ»‹è³€çœŒ': {lat: 35.0045, lng: 135.8686},
            'äº¬éƒ½åºœ': {lat: 35.0213, lng: 135.7556},
            'å¤§é˜ªåºœ': {lat: 34.6863, lng: 135.5200},
            'å…µåº«çœŒ': {lat: 34.6901, lng: 135.1830},
            'å¥ˆè‰¯çœŒ': {lat: 34.6851, lng: 135.8329},
            'å’Œæ­Œå±±çœŒ': {lat: 34.2260, lng: 135.1675},
            'é³¥å–çœŒ': {lat: 35.5039, lng: 134.2378},
            'å³¶æ ¹çœŒ': {lat: 35.4723, lng: 133.0505},
            'å²¡å±±çœŒ': {lat: 34.6617, lng: 133.9350},
            'åºƒå³¶çœŒ': {lat: 34.3966, lng: 132.4596},
            'å±±å£çœŒ': {lat: 34.1859, lng: 131.4705},
            'å¾³å³¶çœŒ': {lat: 34.0658, lng: 134.5593},
            'é¦™å·çœŒ': {lat: 34.3401, lng: 134.0434},
            'æ„›åª›çœŒ': {lat: 33.8416, lng: 132.7657},
            'é«˜çŸ¥çœŒ': {lat: 33.5597, lng: 133.5311},
            'ç¦å²¡çœŒ': {lat: 33.6064, lng: 130.4183},
            'ä½è³€çœŒ': {lat: 33.2494, lng: 130.2988},
            'é•·å´çœŒ': {lat: 32.7448, lng: 129.8737},
            'ç†Šæœ¬çœŒ': {lat: 32.7898, lng: 130.7417},
            'å¤§åˆ†çœŒ': {lat: 33.2382, lng: 131.6126},
            'å®®å´çœŒ': {lat: 31.9111, lng: 131.4239},
            'é¹¿å…å³¶çœŒ': {lat: 31.5602, lng: 130.5581},
            'æ²–ç¸„çœŒ': {lat: 26.2124, lng: 127.6809}
        };
        
        const baseCoords = prefCoords[prefName];
        if (baseCoords) {
            // éƒ½é“åºœçœŒå†…ã§ãƒ©ãƒ³ãƒ€ãƒ ã«å°‘ã—ãšã‚‰ã™ï¼ˆé™¸åœ°ã®ç¯„å›²å†…ã«åã‚ã‚‹ï¼‰
            const offset = 0.3; // æœ€å¤§ã‚ªãƒ•ã‚»ãƒƒãƒˆé‡ã‚’æ¸›ã‚‰ã™
            return {
                lat: baseCoords.lat + (Math.random() - 0.5) * offset,
                lng: baseCoords.lng + (Math.random() - 0.5) * offset,
                name: cityName
            };
        }
        
        return null;
    }
    
    // Excelãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    async function loadIncomeData() {
        try {
            const response = await fetch('./comprehensive_japanese_household_income_dataset_12k.xlsx');
            
            if (!response.ok) {
                throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${response.status}`);
            }
            
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            console.log('ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«:', jsonData.slice(0, 3));
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
            jsonData.forEach(row => {
                const prefCode = String(row['JISéƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰'] || '').padStart(2, '0');
                const cityCode = String(row['JISå¸‚åŒºç”ºæ‘ã‚³ãƒ¼ãƒ‰'] || '');
                const smallCode = String(row['å°åœ°åŸŸã‚³ãƒ¼ãƒ‰'] || '');
                const income = parseFloat(row['ä¸–å¸¯å¹´å_ä¸‡å††']) || 0;
                const taxable = parseFloat(row['èª²ç¨å¯¾è±¡æ‰€å¾—_åƒå††']) || 0;
                const prefName = row['éƒ½é“åºœçœŒå'];
                const cityName = row['å¸‚åŒºç”ºæ‘å'];
                
                if (cityCode && income > 0) {
                    // 6æ¡ã‚³ãƒ¼ãƒ‰ï¼ˆå¸‚åŒºç”ºæ‘ï¼‰
                    const code6 = prefCode + cityCode.padStart(4, '0');
                    
                    // åº§æ¨™ã‚’å–å¾—
                    const coords = getCoordinatesForCity(code6, cityName, prefName);
                    
                    if (coords) {
                        municipalityData[code6] = {
                            prefecture: prefName,
                            city: cityName,
                            income: income,
                            taxable: taxable,
                            households: parseInt(row['æ¨å®šä¸–å¸¯æ•°']) || 0,
                            year: row['ãƒ‡ãƒ¼ã‚¿å¹´åº¦'],
                            source: row['ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹'],
                            lat: coords.lat,
                            lng: coords.lng
                        };
                    }
                }
                
                if (smallCode && income > 0) {
                    // 11æ¡ã‚³ãƒ¼ãƒ‰ï¼ˆå°åœ°åŸŸï¼‰
                    const code11 = prefCode + cityCode.padStart(4, '0') + smallCode.padStart(5, '0');
                    
                    // å¸‚åŒºç”ºæ‘ã®åº§æ¨™ã‚’ãƒ™ãƒ¼ã‚¹ã«å°‘ã—ãšã‚‰ã™
                    const code6 = prefCode + cityCode.padStart(4, '0');
                    const baseCoords = getCoordinatesForCity(code6, cityName, prefName);
                    
                    if (baseCoords) {
                        smallAreaData[code11] = {
                            prefecture: prefName,
                            city: cityName,
                            area: row['å°åœ°åŸŸå'],
                            income: income,
                            taxable: taxable,
                            households: parseInt(row['æ¨å®šä¸–å¸¯æ•°']) || 0,
                            year: row['ãƒ‡ãƒ¼ã‚¿å¹´åº¦'],
                            source: row['ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹'],
                            lat: baseCoords.lat + (Math.random() - 0.5) * 0.05,
                            lng: baseCoords.lng + (Math.random() - 0.5) * 0.05
                        };
                    }
                }
            });
            
            console.log('å¸‚åŒºç”ºæ‘ãƒ‡ãƒ¼ã‚¿æ•°:', Object.keys(municipalityData).length);
            console.log('å°åœ°åŸŸãƒ‡ãƒ¼ã‚¿æ•°:', Object.keys(smallAreaData).length);
            
            // éƒ½é“åºœçœŒãƒªã‚¹ãƒˆã‚’ä½œæˆ
            const prefectures = new Set();
            Object.values(municipalityData).forEach(data => {
                if (data.prefecture) prefectures.add(data.prefecture);
            });
            
            const prefSelect = document.getElementById('prefectureFilter');
            Array.from(prefectures).sort().forEach(pref => {
                const option = document.createElement('option');
                option.value = pref;
                option.textContent = pref;
                prefSelect.appendChild(option);
            });
            
            updateStatistics();
            
        } catch (error) {
            console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            throw error;
        }
    }
    
    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®ä½œæˆ
    function createHeatmap() {
        // æ—¢å­˜ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤
        if (heatmapLayer) {
            map.removeLayer(heatmapLayer);
        }
        if (markerLayer) {
            map.removeLayer(markerLayer);
            markerLayer.clearLayers();
        }
        
        const dataSource = currentDataLevel === 'municipality' ? municipalityData : smallAreaData;
        const heatData = [];
        
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
        Object.values(dataSource).forEach(data => {
            if (data.lat && data.lng && data.income > 0) {
                // åå…¥ã‚’æ­£è¦åŒ–ï¼ˆ0-1ã®ç¯„å›²ï¼‰
                const intensity = Math.min(data.income / 800, 1);
                
                // ãƒ¡ã‚¤ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ
                heatData.push([data.lat, data.lng, intensity]);
                
                // å‘¨è¾ºã«ã‚‚å°‘ã—ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹ãŸã‚ï¼‰
                for (let i = 0; i < 3; i++) {
                    const offsetLat = data.lat + (Math.random() - 0.5) * 0.02;
                    const offsetLng = data.lng + (Math.random() - 0.5) * 0.02;
                    heatData.push([offsetLat, offsetLng, intensity * 0.8]);
                }
            }
        });
        
        console.log('ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆæ•°:', heatData.length);
        
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆ
        if (heatData.length > 0) {
            heatmapLayer = L.heatLayer(heatData, {
                radius: 25,
                blur: 15,
                maxZoom: 10,
                max: 1.0,
                gradient: {
                    0.0: 'blue',
                    0.25: 'cyan',
                    0.5: 'lime',
                    0.65: 'yellow',
                    0.8: 'orange',
                    0.95: 'red',
                    1.0: 'darkred'
                }
            }).addTo(map);
        }
        
        // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒé«˜ã„æ™‚ã¯ãƒãƒ¼ã‚«ãƒ¼ã‚‚è¿½åŠ 
        map.on('zoomend', function() {
            updateMarkersOnZoom();
        });
    }
    
    // ã‚ºãƒ¼ãƒ æ™‚ã®ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
    function updateMarkersOnZoom() {
        const zoom = map.getZoom();
        
        // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒ10ä»¥ä¸Šã®æ™‚ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
        if (zoom >= 10) {
            if (markerLayer) {
                markerLayer.clearLayers();
            }
            
            const dataSource = currentDataLevel === 'municipality' ? municipalityData : smallAreaData;
            const bounds = map.getBounds();
            
            Object.values(dataSource).forEach(data => {
                if (data.lat && data.lng && bounds.contains([data.lat, data.lng])) {
                    const marker = L.circleMarker([data.lat, data.lng], {
                        radius: 5,
                        fillColor: getColor(data.income),
                        color: '#fff',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    const popupContent = `
                        <div class="popup-content">
                            <h5>${data.prefecture} ${data.city}${data.area ? ' ' + data.area : ''}</h5>
                            <div class="income-value">${data.income.toFixed(1)}ä¸‡å††</div>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    
                    markerLayer.addLayer(marker);
                }
            });
            
            if (!map.hasLayer(markerLayer)) {
                markerLayer.addTo(map);
            }
        } else {
            // ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã¯ãƒãƒ¼ã‚«ãƒ¼ã‚’éè¡¨ç¤º
            if (map.hasLayer(markerLayer)) {
                map.removeLayer(markerLayer);
            }
        }
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ¬ãƒ™ãƒ«ã®åˆ‡ã‚Šæ›¿ãˆ
    function switchDataLevel(level) {
        currentDataLevel = level;
        
        // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
        document.getElementById('btnMunicipality').classList.toggle('active', level === 'municipality');
        document.getElementById('btnSmallArea').classList.toggle('active', level === 'smallarea');
        
        // è¡¨ç¤ºã‚’æ›´æ–°
        document.getElementById('currentLevel').textContent = level === 'municipality' ? 'å¸‚åŒºç”ºæ‘' : 'å°åœ°åŸŸ';
        
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’å†ä½œæˆ
        createHeatmap();
        updateStatistics();
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ›´æ–°
    function updateDataField() {
        currentDataField = document.getElementById('dataField').value;
        createHeatmap();
    }
    
    // é€æ˜åº¦ã®æ›´æ–°
    function updateOpacity() {
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®é€æ˜åº¦èª¿æ•´ã¯ç›´æ¥ã§ããªã„ãŸã‚ã€å†ä½œæˆ
        createHeatmap();
    }
    
    // éƒ½é“åºœçœŒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    function filterByPrefecture() {
        const selectedPref = document.getElementById('prefectureFilter').value;
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã«å†æç”»
        createHeatmap();
        
        // é¸æŠã•ã‚ŒãŸéƒ½é“åºœçœŒã«ã‚ºãƒ¼ãƒ 
        if (selectedPref) {
            const dataSource = currentDataLevel === 'municipality' ? municipalityData : smallAreaData;
            const prefData = Object.values(dataSource).filter(d => d.prefecture === selectedPref);
            
            if (prefData.length > 0) {
                const lats = prefData.map(d => d.lat);
                const lngs = prefData.map(d => d.lng);
                const bounds = L.latLngBounds(
                    [Math.min(...lats), Math.min(...lngs)],
                    [Math.max(...lats), Math.max(...lngs)]
                );
                map.fitBounds(bounds);
            }
        }
    }
    
    // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
    function updateStatistics() {
        const dataSource = currentDataLevel === 'municipality' ? municipalityData : smallAreaData;
        const selectedPref = document.getElementById('prefectureFilter').value;
        
        let values = Object.values(dataSource)
            .filter(d => !selectedPref || d.prefecture === selectedPref)
            .map(d => d.income)
            .filter(v => v > 0);
        
        if (values.length > 0) {
            const avg = values.reduce((sum, v) => sum + v, 0) / values.length;
            const max = Math.max(...values);
            const min = Math.min(...values);
            
            document.getElementById('dataCount').textContent = values.length.toLocaleString();
            document.getElementById('avgIncome').textContent = avg.toFixed(1);
            document.getElementById('maxIncome').textContent = max.toFixed(1);
            document.getElementById('minIncome').textContent = min.toFixed(1);
        } else {
            document.getElementById('dataCount').textContent = '0';
            document.getElementById('avgIncome').textContent = '-';
            document.getElementById('maxIncome').textContent = '-';
            document.getElementById('minIncome').textContent = '-';
        }
    }
    
    // ãƒ¡ã‚¤ãƒ³å‡¦ç†
    async function main() {
        try {
            // åœ°å›³ã®åˆæœŸåŒ–
            initializeMap();
            
            // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
            await loadIncomeData();
            
            // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®ä½œæˆ
            createHeatmap();
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
            document.getElementById('loading').style.display = 'none';
            
        } catch (error) {
            console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('loading').innerHTML = `
                <div style="color: red;">
                    ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ<br>
                    <small>${error.message}</small>
                </div>
            `;
        }
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', main);
</script>
```

</body>
</html>