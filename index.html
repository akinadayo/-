<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬å…¨å›½ä¸–å¸¯å¹´åãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</title>

```
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        background: #f5f5f5;
    }
    
    #map {
        height: 100vh;
        width: 100%;
    }
    
    .info-popup {
        position: absolute;
        top: 80px;
        right: 20px;
        background: rgba(255,255,255,0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        min-width: 250px;
        font-size: 14px;
    }
    
    .info-popup h3 {
        margin: 0 0 10px 0;
        font-size: 16px;
        font-weight: bold;
    }
    
    .data-legend {
        margin-top: 10px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
        font-size: 13px;
    }
    
    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        border: 1px solid rgba(0,0,0,0.2);
    }
    
    .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 20px;
        height: 20px;
        line-height: 18px;
    }
    
    .close-btn:hover {
        color: #333;
    }
    
    .legend-box {
        position: absolute;
        bottom: 30px;
        right: 20px;
        background: rgba(255,255,255,0.95);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        font-size: 12px;
        z-index: 1000;
    }
    
    .legend-box h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        font-weight: bold;
    }
    
    .legend-box .legend-item {
        display: flex;
        align-items: center;
        margin: 4px 0;
        font-size: 12px;
    }
    
    .legend-box .legend-color {
        width: 25px;
        height: 16px;
        margin-right: 8px;
        border-radius: 2px;
        border: 1px solid rgba(0,0,0,0.1);
    }
    
    .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px 50px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 2000;
        text-align: center;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #fff;
        color: #d32f2f;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 2001;
        max-width: 400px;
        text-align: center;
    }
    
    .error-message h3 {
        margin: 0 0 10px 0;
        color: #d32f2f;
    }
    
    .error-message button {
        margin-top: 15px;
        padding: 8px 16px;
        background: #d32f2f;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .error-message button:hover {
        background: #b71c1c;
    }
</style>
```

</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        <div style="font-size: 12px; margin-top: 8px; color: #666;">
            å…¨å›½ã®ä¸–å¸¯å¹´åãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¦ã„ã¾ã™
        </div>
    </div>

```
<div id="map"></div>

<!-- ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆçµ±è¨ˆ -->
<div class="info-popup" id="infoPopup">
    <button class="close-btn" onclick="this.parentElement.style.display='none'">Ã—</button>
    <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆçµ±è¨ˆ</h3>
    <div>ç·ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ: <span id="totalPoints">0</span>å€‹</div>
    <div class="data-legend">
        <h4 style="font-size: 14px; margin: 10px 0 5px 0;">ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</h4>
        <div class="legend-item">
            <div class="legend-color" style="background: #dc3545;"></div>
            <span>èµ¤è‰²: é«˜æ‰€å¾—åœ°åŸŸï¼ˆ600ä¸‡å††ä»¥ä¸Šï¼‰</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ffc107;"></div>
            <span>é»„è‰²: ä¸­æ‰€å¾—åœ°åŸŸï¼ˆ500-600ä¸‡å††ï¼‰</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #28a745;"></div>
            <span>é’è‰²: ä½æ‰€å¾—åœ°åŸŸï¼ˆ500ä¸‡å††æœªæº€ï¼‰</span>
        </div>
    </div>
    <div style="margin-top: 10px; font-size: 11px; color: #666;">
        â€» ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º<br>
        â€» ã‚ºãƒ¼ãƒ ã§è©³ç´°åº¦ãŒå¤‰åŒ–
    </div>
</div>

<!-- å‡¡ä¾‹ -->
<div class="legend-box">
    <h4>ä¸–å¸¯å¹´åï¼ˆä¸‡å††ï¼‰</h4>
    <div class="legend-item">
        <div class="legend-color" style="background: #800026;"></div>
        <span>650+</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #a50026;"></div>
        <span>600-650</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #d73027;"></div>
        <span>550-600</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #f46d43;"></div>
        <span>500-550</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #fdae61;"></div>
        <span>480-500</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #fee090;"></div>
        <span>450-480</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #ffffbf;"></div>
        <span>420-450</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #e0f3f8;"></div>
        <span>400-420</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #abd9e9;"></div>
        <span>0-400</span>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<!-- Leaflet Heat -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<!-- SheetJS for Excel reading -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    // å¸‚åŒºç”ºæ‘ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åº§æ¨™ã‚’å–å¾—ã™ã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆä¸»è¦éƒ½å¸‚ï¼‰
    const cityCodeToCoordinates = {
        // åŒ—æµ·é“
        '0110001': {lat: 43.0642, lng: 141.3469, name: 'æœ­å¹Œå¸‚ä¸­å¤®åŒº'},
        '0110002': {lat: 43.0748, lng: 141.3408, name: 'æœ­å¹Œå¸‚åŒ—åŒº'},
        '0110003': {lat: 43.0982, lng: 141.3847, name: 'æœ­å¹Œå¸‚æ±åŒº'},
        '0110004': {lat: 43.0548, lng: 141.3196, name: 'æœ­å¹Œå¸‚è¥¿åŒº'},
        '0120001': {lat: 41.7743, lng: 140.7370, name: 'å‡½é¤¨å¸‚'},
        '0120401': {lat: 42.9849, lng: 144.3820, name: 'é‡§è·¯å¸‚'},
        
        // å®®åŸçœŒ
        '0410001': {lat: 38.2682, lng: 140.8694, name: 'ä»™å°å¸‚é’è‘‰åŒº'},
        '0410002': {lat: 38.2488, lng: 140.8828, name: 'ä»™å°å¸‚è‹¥æ—åŒº'},
        '0410003': {lat: 38.2613, lng: 140.9826, name: 'ä»™å°å¸‚å®®åŸé‡åŒº'},
        
        // æ±äº¬éƒ½
        '1310101': {lat: 35.6762, lng: 139.6503, name: 'åƒä»£ç”°åŒº'},
        '1310102': {lat: 35.6595, lng: 139.7005, name: 'æ¸¯åŒº'},
        '1310103': {lat: 35.6938, lng: 139.7034, name: 'æ–°å®¿åŒº'},
        '1310104': {lat: 35.7295, lng: 139.7109, name: 'æ–‡äº¬åŒº'},
        '1310105': {lat: 35.6850, lng: 139.7746, name: 'å°æ±åŒº'},
        '1310106': {lat: 35.6828, lng: 139.7746, name: 'å¢¨ç”°åŒº'},
        '1310107': {lat: 35.6850, lng: 139.8090, name: 'æ±Ÿæ±åŒº'},
        '1310108': {lat: 35.6923, lng: 139.6952, name: 'å“å·åŒº'},
        '1310109': {lat: 35.6531, lng: 139.6557, name: 'ç›®é»’åŒº'},
        '1310110': {lat: 35.6338, lng: 139.7163, name: 'å¤§ç”°åŒº'},
        '1310111': {lat: 35.6090, lng: 139.6680, name: 'ä¸–ç”°è°·åŒº'},
        '1310112': {lat: 35.6640, lng: 139.6982, name: 'æ¸‹è°·åŒº'},
        '1310113': {lat: 35.7023, lng: 139.5603, name: 'ä¸­é‡åŒº'},
        '1310114': {lat: 35.7023, lng: 139.5803, name: 'æ‰ä¸¦åŒº'},
        '1310115': {lat: 35.7539, lng: 139.6910, name: 'è±Šå³¶åŒº'},
        '1310116': {lat: 35.7320, lng: 139.7390, name: 'åŒ—åŒº'},
        '1310117': {lat: 35.7477, lng: 139.7638, name: 'è’å·åŒº'},
        '1310118': {lat: 35.7338, lng: 139.6566, name: 'æ¿æ©‹åŒº'},
        '1310119': {lat: 35.7509, lng: 139.6566, name: 'ç·´é¦¬åŒº'},
        '1310120': {lat: 35.7472, lng: 139.8089, name: 'è¶³ç«‹åŒº'},
        '1310121': {lat: 35.7339, lng: 139.8608, name: 'è‘›é£¾åŒº'},
        '1310122': {lat: 35.6065, lng: 139.8352, name: 'æ±Ÿæˆ¸å·åŒº'},
        
        // ç¥å¥ˆå·çœŒ
        '1410001': {lat: 35.4437, lng: 139.6380, name: 'æ¨ªæµœå¸‚ä¸­åŒº'},
        '1410002': {lat: 35.4657, lng: 139.6222, name: 'æ¨ªæµœå¸‚è¥¿åŒº'},
        '1410003': {lat: 35.5111, lng: 139.6361, name: 'æ¨ªæµœå¸‚æ¸¯åŒ—åŒº'},
        '1410004': {lat: 35.5532, lng: 139.5459, name: 'æ¨ªæµœå¸‚é’è‘‰åŒº'},
        '1413001': {lat: 35.5307, lng: 139.7029, name: 'å·å´å¸‚å·å´åŒº'},
        '1413002': {lat: 35.5876, lng: 139.6486, name: 'å·å´å¸‚ä¸­åŸåŒº'},
        
        // æ„›çŸ¥çœŒ
        '2310001': {lat: 35.1815, lng: 136.9066, name: 'åå¤å±‹å¸‚ä¸­åŒº'},
        '2310002': {lat: 35.1709, lng: 136.8815, name: 'åå¤å±‹å¸‚æ˜­å’ŒåŒº'},
        '2310003': {lat: 35.1628, lng: 136.9355, name: 'åå¤å±‹å¸‚åƒç¨®åŒº'},
        '2310004': {lat: 35.2070, lng: 136.9720, name: 'åæ±åŒº'},
        '2310005': {lat: 35.1765, lng: 137.0027, name: 'å¤©ç™½åŒº'},
        '2310006': {lat: 35.1412, lng: 136.9065, name: 'ç‘ç©‚åŒº'},
        '2310007': {lat: 35.1944, lng: 136.8815, name: 'è¥¿åŒº'},
        '2310008': {lat: 35.2045, lng: 136.9163, name: 'åŒ—åŒº'},
        '2310009': {lat: 35.1333, lng: 136.8745, name: 'æ¸¯åŒº'},
        '2310010': {lat: 35.1240, lng: 136.9376, name: 'å—åŒº'},
        '2310011': {lat: 35.1390, lng: 136.9630, name: 'ç·‘åŒº'},
        '2310012': {lat: 35.1843, lng: 136.9465, name: 'æ±åŒº'},
        '2310013': {lat: 35.2289, lng: 136.8397, name: 'ä¸­æ‘åŒº'},
        '2310014': {lat: 35.1676, lng: 136.8527, name: 'ä¸­å·åŒº'},
        '2310015': {lat: 35.1269, lng: 136.8086, name: 'ç†±ç”°åŒº'},
        '2310016': {lat: 35.2392, lng: 137.0474, name: 'å®ˆå±±åŒº'},
        
        // å¤§é˜ªåºœ
        '2710001': {lat: 34.6937, lng: 135.5023, name: 'å¤§é˜ªå¸‚åŒ—åŒº'},
        '2710002': {lat: 34.6784, lng: 135.5019, name: 'å¤§é˜ªå¸‚ä¸­å¤®åŒº'},
        '2710003': {lat: 34.6617, lng: 135.5196, name: 'å¤§é˜ªå¸‚æµªé€ŸåŒº'},
        '2710004': {lat: 34.6605, lng: 135.5011, name: 'å¤§é˜ªå¸‚è¥¿æˆåŒº'},
        '2710005': {lat: 34.7324, lng: 135.5003, name: 'å¤§é˜ªå¸‚æ·€å·åŒº'},
        '2710006': {lat: 34.6413, lng: 135.5629, name: 'å¤§é˜ªå¸‚å¤©ç‹å¯ºåŒº'},
        
        // äº¬éƒ½åºœ
        '2610001': {lat: 35.0116, lng: 135.7681, name: 'äº¬éƒ½å¸‚ä¸­äº¬åŒº'},
        '2610002': {lat: 35.0394, lng: 135.7292, name: 'äº¬éƒ½å¸‚å·¦äº¬åŒº'},
        '2610003': {lat: 35.0295, lng: 135.7595, name: 'äº¬éƒ½å¸‚ä¸Šäº¬åŒº'},
        '2610004': {lat: 34.9877, lng: 135.7555, name: 'äº¬éƒ½å¸‚ä¸‹äº¬åŒº'},
        
        // å…µåº«çœŒ
        '2810001': {lat: 34.6901, lng: 135.1955, name: 'ç¥æˆ¸å¸‚ä¸­å¤®åŒº'},
        '2810002': {lat: 34.7202, lng: 135.2345, name: 'ç¥æˆ¸å¸‚æ±ç˜åŒº'},
        
        // ç¦å²¡çœŒ
        '4010001': {lat: 33.5904, lng: 130.4017, name: 'ç¦å²¡å¸‚ä¸­å¤®åŒº'},
        '4010002': {lat: 33.5833, lng: 130.3577, name: 'ç¦å²¡å¸‚æ—©è‰¯åŒº'},
        '4010003': {lat: 33.6195, lng: 130.4246, name: 'ç¦å²¡å¸‚åšå¤šåŒº'},
        
        // å¤§åˆ†çœŒã®è¿½åŠ ï¼ˆæä¾›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãï¼‰
        '4414391': {lat: 33.2792, lng: 131.5000, name: 'åˆ¥åºœå¸‚'}
    };
    
    // city_codeã‹ã‚‰åº§æ¨™ã‚’å–å¾—ã¾ãŸã¯æ¨å®šã™ã‚‹é–¢æ•°
    function getCoordinatesFromCityCode(cityCode, prefectureName, cityName) {
        // å®Œå…¨ä¸€è‡´ã‚’æ¢ã™
        if (cityCodeToCoordinates[cityCode]) {
            return cityCodeToCoordinates[cityCode];
        }
        
        // 7æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’6æ¡ã‚„5æ¡ã«çŸ­ç¸®ã—ã¦æ¢ã™
        const shortCode = cityCode.toString().substring(0, 6);
        if (cityCodeToCoordinates[shortCode]) {
            return cityCodeToCoordinates[shortCode];
        }
        
        // éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ã‹ã‚‰å¤§ã¾ã‹ãªä½ç½®ã‚’æ¨å®š
        const prefCode = cityCode.toString().substring(0, 2);
        const prefectureCoordinates = {
            '01': {lat: 43.0642, lng: 141.3469}, // åŒ—æµ·é“
            '02': {lat: 40.8244, lng: 140.7400}, // é’æ£®çœŒ
            '03': {lat: 39.7036, lng: 141.1527}, // å²©æ‰‹çœŒ
            '04': {lat: 38.2682, lng: 140.8722}, // å®®åŸçœŒ
            '05': {lat: 39.7186, lng: 140.1024}, // ç§‹ç”°çœŒ
            '06': {lat: 38.2404, lng: 140.3637}, // å±±å½¢çœŒ
            '07': {lat: 37.7503, lng: 140.4678}, // ç¦å³¶çœŒ
            '08': {lat: 36.3418, lng: 140.4468}, // èŒ¨åŸçœŒ
            '09': {lat: 36.5657, lng: 139.8836}, // æ ƒæœ¨çœŒ
            '10': {lat: 36.3911, lng: 139.0608}, // ç¾¤é¦¬çœŒ
            '11': {lat: 35.8617, lng: 139.6455}, // åŸ¼ç‰çœŒ
            '12': {lat: 35.6074, lng: 140.1065}, // åƒè‘‰çœŒ
            '13': {lat: 35.6762, lng: 139.6503}, // æ±äº¬éƒ½
            '14': {lat: 35.4478, lng: 139.6425}, // ç¥å¥ˆå·çœŒ
            '15': {lat: 37.9022, lng: 139.0235}, // æ–°æ½ŸçœŒ
            '16': {lat: 36.6953, lng: 137.2113}, // å¯Œå±±çœŒ
            '17': {lat: 36.5947, lng: 136.6256}, // çŸ³å·çœŒ
            '18': {lat: 36.0652, lng: 136.2219}, // ç¦äº•çœŒ
            '19': {lat: 35.6640, lng: 138.5683}, // å±±æ¢¨çœŒ
            '20': {lat: 36.6513, lng: 138.1809}, // é•·é‡çœŒ
            '21': {lat: 35.3912, lng: 136.7223}, // å²é˜œçœŒ
            '22': {lat: 34.9769, lng: 138.3831}, // é™å²¡çœŒ
            '23': {lat: 35.1802, lng: 136.9065}, // æ„›çŸ¥çœŒ
            '24': {lat: 34.7303, lng: 136.5086}, // ä¸‰é‡çœŒ
            '25': {lat: 35.0045, lng: 135.8686}, // æ»‹è³€çœŒ
            '26': {lat: 35.0213, lng: 135.7556}, // äº¬éƒ½åºœ
            '27': {lat: 34.6863, lng: 135.5200}, // å¤§é˜ªåºœ
            '28': {lat: 34.6901, lng: 135.1830}, // å…µåº«çœŒ
            '29': {lat: 34.6851, lng: 135.8329}, // å¥ˆè‰¯çœŒ
            '30': {lat: 34.2260, lng: 135.1675}, // å’Œæ­Œå±±çœŒ
            '31': {lat: 35.5039, lng: 134.2378}, // é³¥å–çœŒ
            '32': {lat: 35.4723, lng: 133.0505}, // å³¶æ ¹çœŒ
            '33': {lat: 34.6617, lng: 133.9350}, // å²¡å±±çœŒ
            '34': {lat: 34.3966, lng: 132.4596}, // åºƒå³¶çœŒ
            '35': {lat: 34.1859, lng: 131.4705}, // å±±å£çœŒ
            '36': {lat: 34.0658, lng: 134.5593}, // å¾³å³¶çœŒ
            '37': {lat: 34.3401, lng: 134.0434}, // é¦™å·çœŒ
            '38': {lat: 33.8416, lng: 132.7657}, // æ„›åª›çœŒ
            '39': {lat: 33.5597, lng: 133.5311}, // é«˜çŸ¥çœŒ
            '40': {lat: 33.6064, lng: 130.4183}, // ç¦å²¡çœŒ
            '41': {lat: 33.2494, lng: 130.2988}, // ä½è³€çœŒ
            '42': {lat: 32.7448, lng: 129.8737}, // é•·å´çœŒ
            '43': {lat: 32.7898, lng: 130.7417}, // ç†Šæœ¬çœŒ
            '44': {lat: 33.2382, lng: 131.6126}, // å¤§åˆ†çœŒ
            '45': {lat: 31.9111, lng: 131.4239}, // å®®å´çœŒ
            '46': {lat: 31.5602, lng: 130.5581}, // é¹¿å…å³¶çœŒ
            '47': {lat: 26.2124, lng: 127.6809}  // æ²–ç¸„çœŒ
        };
        
        if (prefectureCoordinates[prefCode]) {
            // éƒ½é“åºœçœŒã®ä¸­å¿ƒåº§æ¨™ã«å°‘ã—ãƒ©ãƒ³ãƒ€ãƒ ãªã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’åŠ ãˆã‚‹
            const baseCoord = prefectureCoordinates[prefCode];
            return {
                lat: baseCoord.lat + (Math.random() - 0.5) * 0.5,
                lng: baseCoord.lng + (Math.random() - 0.5) * 0.5,
                name: cityName || prefectureName
            };
        }
        
        return null;
    }
    
    // åœ°å›³ã®åˆæœŸåŒ–
    function initializeMap() {
        // æ—¥æœ¬ã®ä¸­å¿ƒåº§æ¨™ï¼ˆã‚ˆã‚Šæ­£ç¢ºãªä½ç½®ï¼‰
        map = L.map('map').setView([36.5, 138.0], 5.8);
        
        // OpenStreetMapã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 18,
            minZoom: 4
        }).addTo(map);
        
        // ãƒãƒ¼ã‚«ãƒ¼ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚ˆã‚Šä¸Šã«è¡¨ç¤ºï¼‰
        markerLayer = L.layerGroup();
    }
    
    // ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆç”»åƒã®å‡¡ä¾‹ã«åˆã‚ã›ãŸé…è‰²ï¼‰
    function getColor(income) {
        return income >= 650 ? '#800026' :
               income >= 600 ? '#a50026' :
               income >= 550 ? '#d73027' :
               income >= 500 ? '#f46d43' :
               income >= 480 ? '#fdae61' :
               income >= 450 ? '#fee090' :
               income >= 420 ? '#ffffbf' :
               income >= 400 ? '#e0f3f8' :
                              '#abd9e9';
    }
    
    // XLSXãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
    async function loadData() {
        try {
            const response = await fetch('./japan_household_income_data.xlsx');
            
            if (!response.ok) {
                throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${response.status}`);
            }
            
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            
            // æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’å–å¾—
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // JSONã«å¤‰æ›
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            console.log('ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«:', jsonData.slice(0, 3));
            
            // ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ï¼ˆcity_codeã‚’ä½¿ç”¨ã—ã¦åº§æ¨™ã‚’å–å¾—ï¼‰
            allData = jsonData.map(row => {
                const cityCode = row.city_code || '';
                const prefectureName = row.prefecture_name || '';
                const cityName = row.city_name || '';
                const income = parseFloat(row.average_income) || 0;
                
                // city_codeã‹ã‚‰åº§æ¨™ã‚’å–å¾—
                const coords = getCoordinatesFromCityCode(cityCode, prefectureName, cityName);
                
                if (!coords) {
                    console.warn('åº§æ¨™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', cityCode, prefectureName, cityName);
                    return null;
                }
                
                return {
                    prefecture_code: row.prefecture_code,
                    prefecture_name: prefectureName,
                    city_code: cityCode,
                    city_name: cityName,
                    district_name: row.district_name || '',
                    sub_area_name: row.sub_area_name || '',
                    latitude: coords.lat,
                    longitude: coords.lng,
                    average_income: income,
                    population: parseInt(row.population) || 0,
                    household_count: parseInt(row.household_count) || 0,
                    area_type: row.area_type || ''
                };
            }).filter(item => {
                // nullã¨ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–
                return item && item.latitude && item.longitude && item.average_income > 0;
            });
            
            if (allData.length === 0) {
                throw new Error('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã®åˆ†å¸ƒã‚’ç¢ºèª
            const prefectures = {};
            allData.forEach(item => {
                if (!prefectures[item.prefecture_name]) {
                    prefectures[item.prefecture_name] = 0;
                }
                prefectures[item.prefecture_name]++;
            });
            
            console.log('éƒ½é“åºœçœŒåˆ¥ãƒ‡ãƒ¼ã‚¿æ•°:', prefectures);
            console.log(`èª­ã¿è¾¼ã¿å®Œäº†: ${allData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿`);
            
            // åå…¥ã®åˆ†å¸ƒã‚’ç¢ºèª
            const incomeRanges = {
                '0-400': allData.filter(d => d.average_income < 400).length,
                '400-450': allData.filter(d => d.average_income >= 400 && d.average_income < 450).length,
                '450-500': allData.filter(d => d.average_income >= 450 && d.average_income < 500).length,
                '500-550': allData.filter(d => d.average_income >= 500 && d.average_income < 550).length,
                '550-600': allData.filter(d => d.average_income >= 550 && d.average_income < 600).length,
                '600+': allData.filter(d => d.average_income >= 600).length
            };
            console.log('åå…¥åˆ†å¸ƒ:', incomeRanges);
            
            // åº§æ¨™ã®ç¯„å›²ã‚’ç¢ºèª
            const latitudes = allData.map(d => d.latitude);
            const longitudes = allData.map(d => d.longitude);
            console.log('ç·¯åº¦ç¯„å›²:', Math.min(...latitudes), 'ã€œ', Math.max(...latitudes));
            console.log('çµŒåº¦ç¯„å›²:', Math.min(...longitudes), 'ã€œ', Math.max(...longitudes));
            
            return allData;
            
        } catch (error) {
            console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            throw error;
        }
    }
    
    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®ä½œæˆ
    function createHeatmap(data) {
        console.log('ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ä½œæˆé–‹å§‹:', data.length + 'ä»¶ã®ãƒ‡ãƒ¼ã‚¿');
        
        if (heatLayer) {
            map.removeLayer(heatLayer);
            heatLayer = null;
        }
        
        if (data.length === 0) {
            console.log('ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®ãŸã‚ã€ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’ä½œæˆã§ãã¾ã›ã‚“');
            return;
        }
        
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ç”¨ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
        const heatData = data.map(item => {
            // å¼·åº¦ã‚’åå…¥ã«åŸºã¥ã„ã¦è¨­å®š
            let intensity = 0.5; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            
            if (item.average_income < 400) {
                intensity = 0.3;
            } else if (item.average_income < 450) {
                intensity = 0.4;
            } else if (item.average_income < 500) {
                intensity = 0.5;
            } else if (item.average_income < 550) {
                intensity = 0.6;
            } else if (item.average_income < 600) {
                intensity = 0.7;
            } else if (item.average_income < 650) {
                intensity = 0.85;
            } else {
                intensity = 1.0;
            }
            
            // [ç·¯åº¦, çµŒåº¦, å¼·åº¦]ã®é…åˆ—ã‚’è¿”ã™
            return [item.latitude, item.longitude, intensity];
        });
        
        console.log('ãƒ’ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«:', heatData.slice(0, 5));
        
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½œæˆ
        try {
            heatLayer = L.heatLayer(heatData, {
                radius: 30,
                blur: 20,
                maxZoom: 10,
                max: 1.0,
                gradient: {
                    0.0: 'blue',
                    0.25: 'cyan',
                    0.5: 'lime',
                    0.65: 'yellow',
                    0.8: 'orange',
                    0.95: 'red',
                    1.0: 'darkred'
                }
            });
            
            // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’åœ°å›³ã«è¿½åŠ 
            heatLayer.addTo(map);
            console.log('ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’åœ°å›³ã«è¿½åŠ ã—ã¾ã—ãŸ');
            
        } catch (error) {
            console.error('ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        }
    }
    
    // ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆ
    function createMarkers(data) {
        markerLayer.clearLayers();
        
        const zoom = map.getZoom();
        
        // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«7ä»¥ä¸Šã§ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºï¼ˆãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã¨ä½µç”¨ï¼‰
        if (zoom >= 7) {
            // è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’åˆ¶é™ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾ç­–ï¼‰
            const bounds = map.getBounds();
            const visibleData = data.filter(item => {
                return bounds.contains([item.latitude, item.longitude]);
            });
            
            // æœ€å¤§300ä»¶ã¾ã§è¡¨ç¤º
            const displayData = visibleData.slice(0, 300);
            
            displayData.forEach(item => {
                const color = getColor(item.average_income);
                
                const marker = L.circleMarker([item.latitude, item.longitude], {
                    radius: zoom >= 10 ? 7 : zoom >= 8 ? 5 : 4,
                    fillColor: color,
                    color: '#fff',
                    weight: 1,
                    opacity: 0.9,
                    fillOpacity: 0.7
                });
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å†…å®¹
                const areaName = [
                    item.prefecture_name,
                    item.city_name,
                    item.district_name
                ].filter(name => name).join(' ');
                
                marker.bindPopup(`
                    <div style="font-size: 13px; min-width: 180px;">
                        <strong>${areaName || 'åœ°åŸŸæƒ…å ±'}</strong><br>
                        <div style="margin: 8px 0; padding: 5px; background: #f8f9fa; border-radius: 4px;">
                            <div style="font-size: 16px; font-weight: bold; color: ${color};">
                                ${item.average_income.toFixed(0)}ä¸‡å††
                            </div>
                        </div>
                        ${item.population ? `äººå£: ${item.population.toLocaleString()}äºº<br>` : ''}
                        ${item.household_count ? `ä¸–å¸¯æ•°: ${item.household_count.toLocaleString()}ä¸–å¸¯` : ''}
                    </div>
                `);
                
                markerLayer.addLayer(marker);
            });
            
            console.log('ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ:', displayData.length + 'å€‹');
        }
    }
    
    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
        document.getElementById('loading').style.display = 'none';
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = `
            <h3>âš ï¸ ã‚¨ãƒ©ãƒ¼</h3>
            <div>${message}</div>
            <button onclick="location.reload()">å†èª­ã¿è¾¼ã¿</button>
        `;
        document.body.appendChild(errorDiv);
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆæ•°ã®æ›´æ–°
    function updateDataPoints(count) {
        const pointsElement = document.getElementById('totalPoints');
        if (pointsElement) {
            pointsElement.textContent = count.toLocaleString();
        }
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    function setupEventListeners() {
        // ã‚ºãƒ¼ãƒ å¤‰æ›´æ™‚ã®å‡¦ç†
        map.on('zoomend', function() {
            const zoom = map.getZoom();
            
            // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®è¨­å®šã‚’èª¿æ•´
            if (heatLayer) {
                if (zoom >= 10) {
                    heatLayer.setOptions({radius: 12, blur: 8});
                } else if (zoom >= 8) {
                    heatLayer.setOptions({radius: 18, blur: 12});
                } else if (zoom >= 6) {
                    heatLayer.setOptions({radius: 22, blur: 15});
                } else {
                    heatLayer.setOptions({radius: 25, blur: 15});
                }
            }
            
            // ãƒãƒ¼ã‚«ãƒ¼ã®æ›´æ–°
            createMarkers(allData);
        });
        
        // åœ°å›³ç§»å‹•æ™‚
        map.on('moveend', function() {
            if (map.getZoom() >= 8) {
                createMarkers(allData);
            }
        });
    }
    
    // ãƒ¡ã‚¤ãƒ³å‡¦ç†
    async function main() {
        try {
            // åœ°å›³ã®åˆæœŸåŒ–
            initializeMap();
            console.log('åœ°å›³ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
            
            // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
            const data = await loadData();
            console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', data.length + 'ä»¶');
            
            // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€æœ€åˆã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’ä¸­å¿ƒã«åœ°å›³ã‚’èª¿æ•´
            if (data.length > 0) {
                // ãƒ‡ãƒ¼ã‚¿ã®ä¸­å¿ƒåº§æ¨™ã‚’è¨ˆç®—
                const latitudes = data.map(d => d.latitude);
                const longitudes = data.map(d => d.longitude);
                const centerLat = (Math.min(...latitudes) + Math.max(...latitudes)) / 2;
                const centerLng = (Math.min(...longitudes) + Math.max(...longitudes)) / 2;
                
                console.log('ãƒ‡ãƒ¼ã‚¿ã®ä¸­å¿ƒåº§æ¨™:', centerLat, centerLng);
                
                // åœ°å›³ã®ä¸­å¿ƒã¨ã‚ºãƒ¼ãƒ ã‚’èª¿æ•´
                if (centerLat && centerLng) {
                    // ãƒ‡ãƒ¼ã‚¿ã®ç¯„å›²ã«åŸºã¥ã„ã¦ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’æ±ºå®š
                    const latRange = Math.max(...latitudes) - Math.min(...latitudes);
                    const lngRange = Math.max(...longitudes) - Math.min(...longitudes);
                    const maxRange = Math.max(latRange, lngRange);
                    
                    let zoomLevel = 5;
                    if (maxRange < 0.5) zoomLevel = 11;
                    else if (maxRange < 1) zoomLevel = 10;
                    else if (maxRange < 2) zoomLevel = 9;
                    else if (maxRange < 5) zoomLevel = 8;
                    else if (maxRange < 10) zoomLevel = 7;
                    else if (maxRange < 20) zoomLevel = 6;
                    
                    map.setView([centerLat, centerLng], zoomLevel);
                    console.log('åœ°å›³ã‚’èª¿æ•´:', centerLat, centerLng, 'ã‚ºãƒ¼ãƒ :', zoomLevel);
                }
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆæ•°ã®è¡¨ç¤º
            updateDataPoints(data.length);
            
            // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’æœ€åˆã«ä½œæˆï¼ˆãƒãƒ¼ã‚«ãƒ¼ã®ä¸‹ã«è¡¨ç¤ºï¼‰
            createHeatmap(data);
            
            // ãƒãƒ¼ã‚«ãƒ¼ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ ï¼ˆãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®ä¸Šã«è¡¨ç¤ºï¼‰
            markerLayer.addTo(map);
            
            // åˆæœŸã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã§ã®ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ
            createMarkers(data);
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            setupEventListeners();
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
            document.getElementById('loading').style.display = 'none';
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            console.log('ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼:', heatLayer);
            console.log('ãƒãƒ¼ã‚«ãƒ¼ãƒ¬ã‚¤ãƒ¤ãƒ¼:', markerLayer);
            
            // 5ç§’å¾Œã«æƒ…å ±ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è‡ªå‹•ã§é–‰ã˜ã‚‹
            setTimeout(() => {
                const popup = document.getElementById('infoPopup');
                if (popup) {
                    popup.style.display = 'none';
                }
            }, 5000);
            
        } catch (error) {
            console.error('ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
            showError('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>japan_household_income_data.xlsxãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', main);
</script>
```

</body>
</html>