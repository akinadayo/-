<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日本全国世帯年収ヒートマップ</title>

```
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
    }
    
    #map {
        height: 100vh;
        width: 100%;
    }
    
    .info {
        padding: 12px 16px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255,255,255,0.95);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 10px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .info h4 {
        margin: 0 0 10px;
        color: #333;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
    }
    
    .legend {
        line-height: 22px;
        color: #555;
        font-size: 13px;
    }
    
    .legend i {
        width: 20px;
        height: 18px;
        float: left;
        margin-right: 10px;
        opacity: 0.9;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    .info-details {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #ddd;
    }
    
    .info-details p {
        margin: 6px 0;
        font-size: 12px;
        line-height: 1.4;
    }
    
    .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px 50px;
        border-radius: 15px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        z-index: 1000;
        font-size: 18px;
        color: #333;
        text-align: center;
        border: 2px solid #e0e0e0;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .stats-panel {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255,255,255,0.95);
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        font-size: 13px;
        border: 1px solid rgba(255,255,255,0.3);
        backdrop-filter: blur(10px);
        min-width: 200px;
    }
    
    .stats-panel h5 {
        margin: 0 0 8px 0;
        font-size: 16px;
        color: #333;
        text-align: center;
    }
    
    .stats-item {
        margin: 5px 0;
        display: flex;
        justify-content: space-between;
    }
    
    .controls-panel {
        position: absolute;
        top: 15px;
        left: 15px;
        background: rgba(255,255,255,0.95);
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        backdrop-filter: blur(10px);
        max-width: 250px;
    }
    
    .controls-panel h5 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #333;
    }
    
    .control-item {
        margin: 8px 0;
    }
    
    .control-item label {
        font-size: 12px;
        color: #555;
        display: block;
        margin-bottom: 3px;
    }
    
    .control-item input, .control-item select {
        width: 100%;
        padding: 4px 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 11px;
    }
    
    .prefecture-filter {
        max-height: 120px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
        background: white;
    }
    
    .prefecture-filter label {
        display: block;
        font-size: 11px;
        margin: 2px 0;
        cursor: pointer;
    }
    
    .prefecture-filter input[type="checkbox"] {
        width: auto;
        margin-right: 5px;
    }
    
    .error-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #ffebee;
        color: #c62828;
        padding: 20px 30px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 1001;
        font-size: 16px;
        text-align: center;
        border: 2px solid #ffcdd2;
        max-width: 400px;
    }
    
    .collapse-btn {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        font-size: 12px;
        float: right;
    }
</style>
```

</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>データを読み込み中...</div>
        <div style="font-size: 14px; margin-top: 10px; color: #666;">
            全国の世帯年収データを処理しています
        </div>
    </div>

```
<div id="map"></div>

<div class="stats-panel">
    <h5>📊 データ統計</h5>
    <div class="stats-item">
        <span>データポイント:</span>
        <span id="dataPoints">計算中...</span>
    </div>
    <div class="stats-item">
        <span>都道府県数:</span>
        <span id="prefectureCount">-</span>
    </div>
    <div class="stats-item">
        <span>平均年収:</span>
        <span id="averageIncome">-</span>
    </div>
    <div class="stats-item">
        <span>最高年収:</span>
        <span id="maxIncome">-</span>
    </div>
    <div class="stats-item">
        <span>最低年収:</span>
        <span id="minIncome">-</span>
    </div>
</div>

<div class="controls-panel" id="controlsPanel">
    <h5>🎛️ 表示設定 <button class="collapse-btn" onclick="toggleControls()">─</button></h5>
    <div id="controlsContent">
        <div class="control-item">
            <label>年収範囲フィルター:</label>
            <select id="incomeFilter">
                <option value="all">すべて表示</option>
                <option value="high">高所得(700万円以上)</option>
                <option value="middle-high">中高所得(550-700万円)</option>
                <option value="middle">中所得(400-550万円)</option>
                <option value="low">低所得(400万円未満)</option>
            </select>
        </div>
        <div class="control-item">
            <label>ヒートマップ強度:</label>
            <input type="range" id="heatIntensity" min="0.3" max="2.0" step="0.1" value="1.0">
        </div>
        <div class="control-item">
            <label>表示する都道府県:</label>
            <div class="prefecture-filter" id="prefectureFilter">
                <!-- 動的に生成 -->
            </div>
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<!-- Leaflet Heat -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<!-- SheetJS for Excel reading -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    // グローバル変数
    let map;
    let heatLayer;
    let markerLayer;
    let allData = [];
    let filteredData = [];
    let prefectures = new Set();

    // 地図の初期化
    function initializeMap() {
        map = L.map('map').setView([36.2048, 138.2529], 6); // 日本中心

        // OpenStreetMapタイルレイヤーの追加
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // レイヤーグループの初期化
        markerLayer = L.layerGroup().addTo(map);
    }

    // カラースケールの定義
    function getColor(income) {
        return income > 800 ? '#800026' :
               income > 700 ? '#BD0026' :
               income > 600 ? '#E31A1C' :
               income > 550 ? '#FC4E2A' :
               income > 500 ? '#FD8D3C' :
               income > 450 ? '#FEB24C' :
               income > 400 ? '#FED976' :
               income > 350 ? '#FFEDA0' :
                              '#FFFFCC';
    }

    // XLSXファイルの読み込み
    async function loadData() {
        try {
            console.log('データファイルを読み込み中...');
            const response = await fetch('./japan_household_income_data.xlsx');
            if (!response.ok) {
                throw new Error(`ファイルの読み込みに失敗しました: ${response.status} ${response.statusText}`);
            }
            
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            
            console.log('Excelファイルを解析中...');
            console.log('利用可能なシート:', workbook.SheetNames);
            
            // 最初のシートを取得
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // JSONに変換
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            console.log(`生データ件数: ${jsonData.length}`);
            console.log('データサンプル:', jsonData.slice(0, 3));
            
            // データの処理とクリーニング
            allData = jsonData.map(row => {
                // 様々な列名パターンに対応
                const prefecture = row.prefecture_name || row['都道府県名'] || row['都道府県'] || '';
                const city = row.city_name || row['市区町村名'] || row['市区町村'] || '';
                const district = row.district_name || row['区・地区名'] || row['区名'] || row['地区名'] || '';
                const subArea = row.sub_area_name || row['詳細地域名'] || row['町丁目'] || row['エリア名'] || '';
                
                const lat = parseFloat(row.latitude || row['緯度'] || 0);
                const lng = parseFloat(row.longitude || row['経度'] || 0);
                const income = parseFloat(row.average_income || row['平均世帯年収'] || row['世帯年収'] || 0);
                const population = parseInt(row.population || row['人口'] || 0);
                const households = parseInt(row.household_count || row['世帯数'] || 0);
                const areaType = row.area_type || row['地域タイプ'] || row['エリアタイプ'] || '';
                
                return {
                    prefecture_name: prefecture,
                    city_name: city,
                    district_name: district,
                    sub_area_name: subArea,
                    latitude: lat,
                    longitude: lng,
                    average_income: income,
                    population: population,
                    household_count: households,
                    area_type: areaType
                };
            }).filter(item => {
                // データ検証
                const hasValidCoords = item.latitude && item.longitude && 
                                      item.latitude >= 20 && item.latitude <= 46 &&
                                      item.longitude >= 123 && item.longitude <= 146;
                const hasValidIncome = item.average_income && item.average_income > 0;
                const hasLocation = item.prefecture_name || item.city_name;
                
                return hasValidCoords && hasValidIncome && hasLocation;
            });

            // 都道府県リストの作成
            allData.forEach(item => {
                if (item.prefecture_name) {
                    prefectures.add(item.prefecture_name);
                }
            });

            console.log(`処理後データ件数: ${allData.length}`);
            console.log(`都道府県数: ${prefectures.size}`);
            console.log('都道府県リスト:', Array.from(prefectures).sort());
            
            if (allData.length === 0) {
                throw new Error('有効なデータが見つかりませんでした。データファイルの形式を確認してください。');
            }
            
            return allData;
            
        } catch (error) {
            console.error('データ読み込みエラー:', error);
            showError(`データファイルの読み込みに失敗しました。<br>エラー: ${error.message}<br><br>japan_household_income_data.xlsxファイルが正しく配置されているか確認してください。`);
            throw error;
        }
    }

    // エラー表示
    function showError(message) {
        document.getElementById('loading').style.display = 'none';
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = `
            <h3>⚠️ エラー</h3>
            <div>${message}</div>
            <button onclick="location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #c62828; color: white; border: none; border-radius: 5px; cursor: pointer;">再読み込み</button>
            <button onclick="this.parentElement.remove()" style="margin-top: 15px; margin-left: 10px; padding: 8px 16px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">閉じる</button>
        `;
        document.body.appendChild(errorDiv);
    }

    // ヒートマップの作成
    function createHeatmap(data) {
        if (data.length === 0) {
            if (heatLayer) {
                map.removeLayer(heatLayer);
                heatLayer = null;
            }
            return;
        }

        const heatData = data.map(item => [
            item.latitude,
            item.longitude,
            Math.min(item.average_income / 1000, 1.2) // 0-1.2の範囲に正規化
        ]);

        if (heatLayer) {
            map.removeLayer(heatLayer);
        }

        heatLayer = L.heatLayer(heatData, {
            radius: 15,
            blur: 12,
            maxZoom: 17,
            max: 1.0,
            gradient: {
                0.0: '#313695',
                0.1: '#4575b4',
                0.2: '#74add1',
                0.3: '#abd9e9',
                0.4: '#e0f3f8',
                0.5: '#ffffbf',
                0.6: '#fee090',
                0.7: '#fdae61',
                0.8: '#f46d43',
                0.9: '#d73027',
                1.0: '#a50026'
            }
        }).addTo(map);
    }

    // マーカーの作成（ズームレベルが高い時のみ）
    function createMarkers(data) {
        markerLayer.clearLayers();
        
        const zoom = map.getZoom();
        if (zoom < 9) return; // ズームレベルが低い時はマーカーを表示しない

        // データをサンプリング（パフォーマンス向上）
        const sampleSize = Math.min(data.length, 500);
        const sampledData = data.sort(() => 0.5 - Math.random()).slice(0, sampleSize);

        sampledData.forEach(item => {
            const marker = L.circleMarker([item.latitude, item.longitude], {
                radius: Math.max(3, Math.min(zoom - 5, 8)),
                fillColor: getColor(item.average_income),
                color: '#fff',
                weight: 1,
                opacity: 0.8,
                fillOpacity: 0.7
            });
            
            const popupContent = createPopupContent(item);
            marker.bindPopup(popupContent);
            markerLayer.addLayer(marker);
        });
    }

    // ポップアップコンテンツの作成
    function createPopupContent(item) {
        const areaName = [
            item.prefecture_name,
            item.city_name,
            item.district_name,
            item.sub_area_name
        ].filter(name => name && name.trim()).join(' ');

        return `
            <div style="font-size: 13px; padding: 5px; min-width: 200px;">
                <strong style="font-size: 14px; color: #333;">${areaName || '地域情報なし'}</strong><br>
                <div style="margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid ${getColor(item.average_income)};">
                    <span style="font-weight: bold; font-size: 16px; color: ${getColor(item.average_income)};">
                        💰 ${item.average_income}万円
                    </span>
                </div>
                ${item.population ? `👥 人口: ${item.population.toLocaleString()}人<br>` : ''}
                ${item.household_count ? `🏠 世帯数: ${item.household_count.toLocaleString()}世帯<br>` : ''}
                ${item.area_type ? `🏢 地域タイプ: ${item.area_type}<br>` : ''}
                <div style="margin-top: 5px; font-size: 11px; color: #666;">
                    📍 ${item.latitude.toFixed(4)}, ${item.longitude.toFixed(4)}
                </div>
            </div>
        `;
    }

    // データの統計情報を更新
    function updateStats(data) {
        const incomes = data.map(item => item.average_income).filter(income => income > 0);
        
        document.getElementById('dataPoints').textContent = data.length.toLocaleString();
        document.getElementById('prefectureCount').textContent = prefectures.size;
        
        if (incomes.length > 0) {
            const avgIncome = Math.round(incomes.reduce((sum, income) => sum + income, 0) / incomes.length);
            const maxIncome = Math.max(...incomes);
            const minIncome = Math.min(...incomes);
            
            document.getElementById('averageIncome').textContent = `${avgIncome}万円`;
            document.getElementById('maxIncome').textContent = `${maxIncome}万円`;
            document.getElementById('minIncome').textContent = `${minIncome}万円`;
        } else {
            document.getElementById('averageIncome').textContent = '-';
            document.getElementById('maxIncome').textContent = '-';
            document.getElementById('minIncome').textContent = '-';
        }
    }

    // フィルターの適用
    function applyFilters() {
        const incomeFilter = document.getElementById('incomeFilter').value;
        const selectedPrefectures = Array.from(document.querySelectorAll('#prefectureFilter input:checked'))
            .map(checkbox => checkbox.value);

        filteredData = allData.filter(item => {
            // 年収フィルター
            let incomeMatch = true;
            switch (incomeFilter) {
                case 'high':
                    incomeMatch = item.average_income >= 700;
                    break;
                case 'middle-high':
                    incomeMatch = item.average_income >= 550 && item.average_income < 700;
                    break;
                case 'middle':
                    incomeMatch = item.average_income >= 400 && item.average_income < 550;
                    break;
                case 'low':
                    incomeMatch = item.average_income < 400;
                    break;
            }

            // 都道府県フィルター
            const prefectureMatch = selectedPrefectures.length === 0 || 
                selectedPrefectures.includes(item.prefecture_name);

            return incomeMatch && prefectureMatch;
        });

        // 表示を更新
        createHeatmap(filteredData);
        createMarkers(filteredData);
        updateStats(filteredData);
        
        console.log(`フィルター適用後: ${filteredData.length}件表示中`);
    }

    // 都道府県フィルターUIの作成
    function createPrefectureFilter() {
        const filterContainer = document.getElementById('prefectureFilter');
        const sortedPrefectures = Array.from(prefectures).sort();
        
        sortedPrefectures.forEach(prefecture => {
            const label = document.createElement('label');
            label.innerHTML = `
                <input type="checkbox" value="${prefecture}" checked> ${prefecture}
            `;
            filterContainer.appendChild(label);
        });

        // 全選択/全解除ボタンの追加
        const controlButtons = document.createElement('div');
        controlButtons.style.marginTop = '8px';
        controlButtons.style.textAlign = 'center';
        controlButtons.innerHTML = `
            <button onclick="toggleAllPrefectures(true)" style="font-size: 10px; margin: 2px; padding: 3px 8px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">全選択</button>
            <button onclick="toggleAllPrefectures(false)" style="font-size: 10px; margin: 2px; padding: 3px 8px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">全解除</button>
        `;
        filterContainer.appendChild(controlButtons);
    }

    // 都道府県の全選択/全解除
    function toggleAllPrefectures(selectAll) {
        const checkboxes = document.querySelectorAll('#prefectureFilter input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll;
        });
        applyFilters();
    }

    // コントロールパネルの折りたたみ
    function toggleControls() {
        const content = document.getElementById('controlsContent');
        const btn = document.querySelector('.collapse-btn');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            btn.textContent = '─';
        } else {
            content.style.display = 'none';
            btn.textContent = '+';
        }
    }

    // 情報コントロールの追加
    function addInfoControl() {
        const info = L.control();
        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };

        info.update = function () {
            this._div.innerHTML = '<h4>🗾 日本全国世帯年収ヒートマップ</h4>' +
                '<div class="info-details">' +
                '<p><strong>📊 データの見方:</strong></p>' +
                '<p>🔴 赤色: 高所得地域 (700万円以上)</p>' +
                '<p>🟡 黄色: 中所得地域 (400-700万円)</p>' +
                '<p>🔵 青色: 低所得地域 (400万円未満)</p>' +
                '<p><strong>💡 操作方法:</strong></p>' +
                '<p>• ズームイン: 詳細マーカー表示</p>' +
                '<p>• マーカークリック: 詳細情報表示</p>' +
                '<p>• 左上パネル: フィルター設定</p>' +
                '<p style="margin-top: 8px; font-size: 10px; color: #666;">※ データは統計に基づく推計値です</p>' +
                '</div>';
        };

        info.addTo(map);
    }

    // 凡例の追加
    function addLegend() {
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            const grades = [0, 350, 400, 450, 500, 550, 600, 700, 800];
            
            div.innerHTML = '<h4 style="margin-bottom: 8px;">世帯年収（万円）</h4>';
            
            for (let i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                    grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
            }
            
            return div;
        };
        legend.addTo(map);
    }

    // イベントリスナーの設定
    function setupEventListeners() {
        // フィルターの変更時
        document.getElementById('incomeFilter').addEventListener('change', applyFilters);
        
        // ヒートマップ強度の変更時
        document.getElementById('heatIntensity').addEventListener('input', function(e) {
            if (heatLayer) {
                heatLayer.setOptions({
                    max: parseFloat(e.target.value)
                });
            }
        });

        // 都道府県フィルターの変更時
        document.addEventListener('change', function(e) {
            if (e.target.closest('#prefectureFilter')) {
                applyFilters();
            }
        });

        // ズーム変更時
        map.on('zoomend', function() {
            createMarkers(filteredData);
            
            // ズームレベルに応じてヒートマップを調整
            const zoom = map.getZoom();
            if (heatLayer) {
                if (zoom > 10) {
                    heatLayer.setOptions({radius: 8, blur: 6});
                } else if (zoom > 7) {
                    heatLayer.setOptions({radius: 12, blur: 9});
                } else {
                    heatLayer.setOptions({radius: 15, blur: 12});
                }
            }
        });

        // マップ移動時
        map.on('moveend', function() {
            if (map.getZoom() >= 9) {
                createMarkers(filteredData);
            }
        });
    }

    // メイン処理
    async function main() {
        try {
            console.log('アプリケーション初期化開始');
            
            // 地図初期化
            initializeMap();
            console.log('地図初期化完了');
            
            // データ読み込み
            await loadData();
            console.log('データ読み込み完了');
            
            // 初期表示データの設定
            filteredData = [...allData];
            
            // UI作成
            createPrefectureFilter();
            addInfoControl();
            addLegend();
            console.log('UI作成完了');
            
            // 初期表示
            createHeatmap(filteredData);
            createMarkers(filteredData);
            updateStats(filteredData);
            console.log('初期表示完了');
            
            // イベントリスナー設定
            setupEventListeners();
            console.log('イベントリスナー設定完了');
            
            // ローディング画面を非表示
            document.getElementById('loading').style.display = 'none';
            
            console.log('アプリケーションの初期化完了');
            console.log(`総データ件数: ${allData.length}, 表示中: ${filteredData.length}`);
            
        } catch (error) {
            console.error('初期化エラー:', error);
            document.getElementById('loading').style.display = 'none';
        }
    }

    // アプリケーション開始
    document.addEventListener('DOMContentLoaded', main);
</script>
```

</body>
</html>
